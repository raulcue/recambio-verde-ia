<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- âœ… NOMBRE OFICIAL -->
    <title>Financial Intelligence Recambio Reciclado | ProfitPulse Analytics Engine</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }

        .glass-card {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 2.5rem;
            transition: all 0.3s ease;
        }
        .dark .glass-card {
            background: #0f172a;
            border-color: #1e293b;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .stat-badge {
            font-size: 9px;
            font-weight: 900;
            letter-spacing: 0.1em;
            padding: 4px 10px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        canvas {
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.02));
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">

<!-- ================= HEADER DINÃMICO ================= -->
<div id="app-header"></div>

<!-- ================= CONTENIDO ================= -->
<main class="flex-grow max-w-7xl mx-auto px-6 mt-10 pb-24">

    <!-- TÃTULO PRINCIPAL -->
    <div class="mb-10">
        <h1 class="text-2xl font-black uppercase tracking-tight">
            Financial Intelligence
            <span class="text-blue-600 italic">Recambio Reciclado</span>
        </h1>
        <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">
            ProfitPulse Analytics Engine
        </p>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">

        <!-- Ventas -->
        <div class="glass-card p-8">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ventas Totales</p>
            <h3 id="stat-ventas" class="text-3xl font-black mt-1 tracking-tighter">0â‚¬</h3>
        </div>

        <!-- Beneficio -->
        <div class="glass-card p-8">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Beneficio Estimado</p>
            <h3 id="stat-beneficio" class="text-3xl font-black mt-1 tracking-tighter">0â‚¬</h3>
        </div>

        <!-- Pedidos -->
        <div class="glass-card p-8">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Pedidos Procesados</p>
            <h3 id="stat-pedidos" class="text-3xl font-black mt-1 tracking-tighter">0</h3>
        </div>

        <!-- Ratio -->
        <div class="glass-card p-8 bg-slate-900 text-white border-none">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tasa de Cierre</p>
            <h3 id="stat-ratio" class="text-3xl font-black mt-1 tracking-tighter">â€“</h3>
        </div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- EvoluciÃ³n -->
        <div class="lg:col-span-2 glass-card p-10">
            <h2 class="text-sm font-black uppercase tracking-widest mb-6">EvoluciÃ³n de Ingresos</h2>
            <div class="h-[350px] w-full">
                <canvas id="chartVentas"></canvas>
            </div>
        </div>

        <!-- Incidencias -->
        <div class="glass-card p-10">
            <h2 class="text-sm font-black uppercase tracking-widest mb-6 text-center">Incidencias</h2>
            <div class="h-[250px] w-full">
                <canvas id="chartIncidencias"></canvas>
            </div>
        </div>
    </div>

</main>

<!-- ================= FOOTER DINÃMICO ================= -->
<div id="app-footer"></div>

<!-- ================= LÃ“GICA ================= -->
<script>
let chartVentas = null;
let chartIncidencias = null;

// ---------------- BOOTSTRAP ----------------
async function init() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
    }

    await cargarStats();
}

// ---------------- DATA LOADER ----------------
async function cargarStats() {
    try {
        const res = await fetch('/api/pedidos', { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar pedidos');

        const pedidos = await res.json();
        console.log('ðŸ“Š Pedidos cargados para ProfitPulse:', pedidos.length);

        buildProfitPulseMetrics(pedidos);

        const talleres = aggregateByTaller(pedidos);
        buildChartsFromTalleres(talleres);

    } catch (err) {
        console.error("âŒ Error cargando stats:", err);
    }
}

// ---------------- AGREGACIÃ“N ----------------
function aggregateByTaller(pedidos) {
    const talleres = {};

    pedidos.forEach(p => {
        const taller = p.nombre_usuario || 'Sin Taller';
        const precio = Number(p.precio || 0);
        const coste = Number(p.precio_coste || 0);

        if (!talleres[taller]) {
            talleres[taller] = { pedidos: 0, ventas: 0, beneficio: 0, incidencias: 0 };
        }

        talleres[taller].pedidos++;
        talleres[taller].ventas += precio;

        if (precio > 0 && coste > 0) {
            talleres[taller].beneficio += (precio - coste);
        }

        if (p.estado === 'incidencia') {
            talleres[taller].incidencias++;
        }
    });

    console.log('ðŸ­ SegmentaciÃ³n por taller:', talleres);
    return talleres;
}

// ---------------- KPIs ----------------
function buildProfitPulseMetrics(pedidos) {
    let ventas = 0;
    let beneficio = 0;
    let pedidosConPrecio = 0;

    pedidos.forEach(p => {
        const precio = Number(p.precio || 0);
        const coste = Number(p.precio_coste || 0);

        if (precio > 0) {
            ventas += precio;
            pedidosConPrecio++;
        }

        if (precio > 0 && coste > 0) {
            beneficio += (precio - coste);
        }
    });

    const ratio = pedidos.length
        ? ((pedidosConPrecio / pedidos.length) * 100).toFixed(1)
        : 0;

    document.getElementById('stat-ventas').innerText = `${ventas.toLocaleString()}â‚¬`;
    document.getElementById('stat-beneficio').innerText = `${beneficio.toLocaleString()}â‚¬`;
    document.getElementById('stat-pedidos').innerText = pedidos.length;
    document.getElementById('stat-ratio').innerText = `${ratio}%`;

    console.log('âœ… KPIs:', { ventas, beneficio, pedidos: pedidos.length, ratio });
}

// ---------------- CHARTS ----------------
function buildChartsFromTalleres(talleres) {
    const labels = Object.keys(talleres);
    const ventas = labels.map(t => talleres[t].ventas);
    const incidencias = labels.map(t => talleres[t].incidencias);

    if (chartVentas) chartVentas.destroy();
    if (chartIncidencias) chartIncidencias.destroy();

    chartVentas = new Chart(document.getElementById('chartVentas'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Ventas (â‚¬)',
                data: ventas
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    chartIncidencias = new Chart(document.getElementById('chartIncidencias'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Incidencias',
                data: incidencias
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

window.addEventListener('DOMContentLoaded', init);
</script>

<!-- ================= CARGA HEADER ================= -->
<script>
fetch('/partials/header.html')
    .then(res => res.text())
    .then(html => document.getElementById('app-header').innerHTML = html)
    .catch(err => console.error('Error cargando header:', err));
</script>

<!-- ================= CARGA FOOTER ================= -->
<script>
fetch('/partials/footer.html')
    .then(res => res.text())
    .then(html => document.getElementById('app-footer').innerHTML = html)
    .catch(err => console.error('Error cargando footer:', err));
</script>

</body>
</html>
