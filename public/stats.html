<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Business Intelligence - Recambio Reciclado IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card { background: white; border: 1px solid #f1f5f9; border-radius: 2.5rem; transition: all 0.3s ease; }
        .dark .glass-card { background: #0f172a; border-color: #1e293b; }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* Estilo para los selectores consistente con Talleres/Dashboard */
        .select-custom {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='C19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen transition-colors pb-10 font-sans">

    <nav class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 px-6 py-3 flex justify-between items-center sticky top-0 z-[100]">
        <div class="flex items-center gap-4">
            <img src="/assets/logo.png" alt="Logo" class="h-8 dark:brightness-0 dark:invert">
            <div class="h-5 w-[1px] bg-slate-200 dark:bg-slate-700 hidden sm:block"></div>
            <h1 class="text-slate-800 dark:text-white font-black text-xs uppercase tracking-tighter hidden sm:block">Recambio Reciclado IA</h1>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="document.documentElement.classList.toggle('dark')" class="w-10 h-10 rounded-xl text-slate-400 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block text-yellow-500"></i>
            </button>

            <button class="w-10 h-10 text-slate-400 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl relative">
                <i class="fas fa-bell"></i>
                <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
            </button>

            <div class="relative group">
                <button class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-slate-600 dark:text-slate-300 flex items-center justify-center hover:bg-blue-50 transition-all">
                    <i class="fas fa-th-large"></i>
                </button>
                <div class="absolute right-0 mt-3 w-64 bg-white dark:bg-slate-900 shadow-2xl rounded-[2rem] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all p-5 border border-slate-100 dark:border-slate-800 z-[200]">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4 ml-2">Navegación BI</p>
                    <div class="space-y-1">
                        <a href="dashboard.html" class="flex items-center gap-3 p-3 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-2xl transition-all">
                            <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg flex items-center justify-center text-xs"><i class="fas fa-columns"></i></div>
                            <div><p class="text-[10px] font-black dark:text-white uppercase">Gestión Kanban</p></div>
                        </a>
                        <a href="talleres.html" class="flex items-center gap-3 p-3 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-2xl transition-all">
                            <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-lg flex items-center justify-center text-xs"><i class="fas fa-tools"></i></div>
                            <div><p class="text-[10px] font-black dark:text-white uppercase">Panel Talleres</p></div>
                        </a>
                        <a href="admin-logs.html" class="flex items-center gap-3 p-3 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-2xl transition-all">
                            <div class="w-8 h-8 bg-slate-100 dark:bg-slate-800 text-slate-600 rounded-lg flex items-center justify-center text-xs"><i class="fas fa-terminal"></i></div>
                            <div><p class="text-[10px] font-black dark:text-white uppercase">Logs del Sistema</p></div>
                        </a>
                    </div>
                </div>
            </div>

            <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-black text-xs">AD</div>
        </div>
    </nav>

    <main class="p-6 md:p-10 max-w-[1500px] mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
            <div>
                <h2 class="text-4xl font-black text-slate-900 dark:text-white uppercase tracking-tighter italic">Business <span class="text-blue-600">Intelligence</span></h2>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">IA Engine Active v6.0</span>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 w-full lg:w-auto">
                <select class="select-custom flex-1 lg:w-48 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl px-5 py-3 text-[10px] font-black uppercase shadow-sm outline-none text-slate-500">
                    <option>Todo el año 2025</option>
                    <option>Último Trimestre</option>
                </select>
                <select id="filtroTaller" class="select-custom flex-1 lg:w-56 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl px-5 py-3 text-[10px] font-black uppercase shadow-sm outline-none text-slate-500">
                    <option>Todos los talleres</option>
                </select>
                <button onclick="window.print()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-3 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 transition-all shadow-lg shadow-emerald-500/20">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 mb-8">
            <div class="xl:col-span-5 bg-[#1e1b4b] p-10 rounded-[3.5rem] text-white relative overflow-hidden shadow-2xl">
                <div class="relative z-10">
                    <p class="text-[11px] font-black uppercase tracking-[0.3em] opacity-60">IA Forecast (Mes Próx.)</p>
                    <h3 class="text-6xl font-black mt-4 tracking-tighter">4,088€</h3>
                    <p class="text-[10px] mt-2 opacity-50 uppercase font-bold italic">Proyección basada en tendencia histórica</p>
                </div>
                <i class="fas fa-brain absolute right-[-20px] bottom-[-20px] text-white/5 text-[15rem]"></i>
            </div>
            
            <div class="xl:col-span-7 bg-white dark:bg-slate-900 p-10 rounded-[3.5rem] border dark:border-slate-800 relative shadow-sm">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Punto de Equilibrio</p>
                        <h3 class="text-4xl font-black text-slate-900 dark:text-white mt-2">
                            3,555€ / <span class="text-blue-600" id="manual-cost">1,200€</span>
                        </h3>
                        <div id="status-rentabilidad" class="mt-3 inline-flex items-center gap-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 px-4 py-1.5 rounded-full">
                            <i class="fas fa-check-circle text-[10px]"></i>
                            <span class="text-[10px] font-black uppercase">Operación Rentable</span>
                        </div>
                    </div>
                    <button onclick="setCosteFijo()" class="w-12 h-12 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-slate-400 hover:text-blue-600 hover:rotate-90 transition-all">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
                <div class="w-full bg-slate-100 dark:bg-slate-800 h-3 rounded-full overflow-hidden mt-8">
                    <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-1000" style="width: 75%"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass-card p-8 border-b-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ventas Brutas</p>
                    <i class="fas fa-info-circle text-slate-200"></i>
                </div>
                <h4 class="text-3xl font-black text-slate-900 dark:text-white">3,555€</h4>
            </div>

            <div class="glass-card p-8 border-b-4 border-emerald-500">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Margen Neto</p>
                    <i class="fas fa-info-circle text-slate-200"></i>
                </div>
                <h4 class="text-3xl font-black text-emerald-500">3,555€</h4>
            </div>

            <div class="glass-card p-8 border-b-4 border-purple-500">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lead Time Medio</p>
                    <i class="fas fa-info-circle text-slate-200"></i>
                </div>
                <h4 class="text-3xl font-black text-slate-900 dark:text-white">0.0d</h4>
            </div>

            <div class="glass-card p-8 border-b-4 border-orange-500">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tasa Conversión</p>
                    <i class="fas fa-info-circle text-slate-200"></i>
                </div>
                <h4 class="text-3xl font-black text-orange-600">100.0%</h4>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white dark:bg-slate-900 p-8 rounded-[3.5rem] border dark:border-slate-800 shadow-sm">
                <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest italic mb-8">Evolución de Márgenes</h5>
                <div class="chart-container">
                    <canvas id="chartEvolucion"></canvas>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 p-8 rounded-[3.5rem] border dark:border-slate-800 shadow-sm">
                <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest italic mb-8">Incidencias y Rechazos</h5>
                <div class="chart-container">
                    <canvas id="chartIncidencias"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Lógica de Punto de Equilibrio
        function setCosteFijo() {
            const cost = prompt("Introduce tus costes fijos mensuales (€):", "1200");
            if(cost) {
                document.getElementById('manual-cost').innerText = cost + "€";
                const ventas = 3555;
                const porcentaje = Math.min((ventas / cost) * 100, 100);
                document.getElementById('progress-bar').style.width = porcentaje + "%";
            }
        }

        // Cargar talleres para filtro (Sincronizado con server.js)
        async function cargarTalleres() {
            try {
                const res = await fetch('/api/talleres');
                const talleres = await res.json();
                const select = document.getElementById('filtroTaller');
                talleres.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.nombre.toUpperCase();
                    select.appendChild(opt);
                });
            } catch (e) { console.error("Error al cargar talleres"); }
        }

        // Configuración de Gráficos
        const initCharts = () => {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.font.family = 'Inter, system-ui, sans-serif';

            // Gráfico de Evolución
            new Chart(document.getElementById('chartEvolucion'), {
                type: 'line',
                data: {
                    labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    datasets: [{
                        label: 'Ventas',
                        data: [800, 1700, 1400, 1755],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true, tension: 0.4
                    }, {
                        label: 'Beneficio',
                        data: [300, 900, 600, 800],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Gráfico de Incidencias
            new Chart(document.getElementById('chartIncidencias'), {
                type: 'bar',
                data: {
                    labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie'],
                    datasets: [{
                        label: 'Rechazos Precio',
                        data: [0.2, 0.8, 0.4, 0.5, 0.3],
                        backgroundColor: '#f59e0b',
                        borderRadius: 8
                    }, {
                        label: 'Devoluciones',
                        data: [0.1, 0.3, 0.6, 0.2, 0.1],
                        backgroundColor: '#ef4444',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            cargarTalleres();
            initCharts();
        });
    </script>
</body>
</html>
