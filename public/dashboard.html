<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro - Recambio Verde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .kanban-column { min-height: 70vh; transition: all 0.3s ease; }
        .drag-over { background-color: rgba(34, 197, 94, 0.1) !important; border: 2px dashed #22c55e; }
        .card-pieza { cursor: grab; transition: all 0.2s; }
        .card-pieza:active { cursor: grabbing; scale: 0.96; }
        .selected-card { outline: 3px solid #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        .column-collapsed { width: 60px !important; min-width: 60px !important; }
        .column-collapsed .items-container, .column-collapsed h2, .column-collapsed .line-header { display: none; }
        .bottleneck { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0%, 100% { background: transparent; } 50% { background: rgba(239, 68, 68, 0.1); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 h-screen flex flex-col overflow-hidden transition-colors duration-300 font-['Inter',sans-serif]">

    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md h-16 flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-800 z-50">
        <div class="flex items-center gap-4">
            <div id="companyLogo" class="w-9 h-9 bg-green-500 rounded-xl flex items-center justify-center shadow-lg shadow-green-200 dark:shadow-none">
                <i class="fas fa-recycle text-white text-sm"></i>
            </div>
            <h1 class="font-black text-slate-800 dark:text-white text-[10px] tracking-tighter uppercase">Recambio<span class="text-green-600">Verde IA</span></h1>
        </div>

        <div class="flex-1 max-w-4xl px-10 flex items-center gap-4">
            <select id="filterTaller" onchange="renderPedidos()" class="bg-slate-100 dark:bg-slate-800 text-[9px] font-black px-4 py-2 rounded-full border-none dark:text-white outline-none cursor-pointer">
                <option value="todos">TODOS LOS TALLERES</option>
            </select>

            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                <input type="text" id="searchInput" oninput="renderPedidos()" placeholder="BUSCAR MATRÍCULA, PIEZA O BASTIDOR..." 
                    class="w-full pl-10 pr-12 py-2 bg-slate-100 dark:bg-slate-800 border-none rounded-full text-[10px] font-bold dark:text-white outline-none focus:ring-2 focus:ring-green-500 uppercase tracking-wider">
                <button onclick="triggerOCR()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-green-500 transition-colors">
                    <i class="fas fa-camera"></i>
                </button>
            </div>

            <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full">
                <input type="range" id="zoomSlider" min="0.6" max="1.1" step="0.1" value="1" class="w-16 h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer">
                <i class="fas fa-search text-[8px] text-slate-400"></i>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="showVersionInfo()" class="w-9 h-9 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition-all">
                <i class="fas fa-rocket text-xs"></i>
            </button>
            <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-yellow-400 flex items-center justify-center">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
            <div class="w-9 h-9 bg-slate-900 border-2 border-white text-white rounded-full flex items-center justify-center text-[10px] font-black shadow-md">AD</div>
        </div>
    </nav>

    <div class="px-8 pt-6 flex justify-between items-end">
        <div>
            <h2 class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter">Panel de Control Avanzado</h2>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em]">Gestión de Agentes Activos: <input type="number" id="activeAgents" value="1" class="bg-transparent w-6 outline-none text-green-600"></p>
        </div>
        <div class="flex gap-3">
            <select id="viewSelector" onchange="renderPedidos()" class="bg-white dark:bg-slate-800 text-[9px] font-black px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 dark:text-white outline-none">
                <option value="normal">VISTA NORMAL</option>
                <option value="avanzada">VISTA AVANZADA (TÉCNICA)</option>
            </select>
            <button onclick="pullData()" class="p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-500 hover:text-green-500 shadow-sm transition-all">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <main id="kanbanBoard" class="flex-1 overflow-x-auto p-8 flex gap-6 min-w-max transition-transform duration-300 origin-top-left">
        <script>
            const cols = [
                { id: 'solicitado', label: 'SOLICITADO', color: '#64748b' },
                { id: 'desguace', label: 'EN DESGUACE', color: '#f59e0b' },
                { id: 'listo', label: 'LISTO / VERIFICADO', color: '#8b5cf6' },
                { id: 'transito', label: 'EN TRÁNSITO', color: '#10b981' },
                { id: 'entregado', label: 'ENTREGADO', color: '#3b82f6' },
                { id: 'incidencia', label: 'INCIDENCIA', color: '#ef4444' }
            ];
            cols.forEach(c => {
                document.write(`
                    <div class="w-72 flex flex-col group transition-all duration-500" id="col-${c.id}">
                        <div class="flex justify-between items-center mb-1 px-1">
                            <h2 class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">${c.label}</h2>
                            <span id="cnt-${c.id}" class="text-[10px] font-black text-slate-400">0</span>
                        </div>
                        <div class="line-header h-[3px] w-full mb-6 rounded-full" style="background-color: ${c.color}20">
                            <div class="h-full w-1/3 rounded-full" style="background-color: ${c.color}"></div>
                        </div>
                        <div class="kanban-column items-container flex-1 bg-slate-100/50 dark:bg-slate-900/40 rounded-[2.5rem] p-4 space-y-4 overflow-y-auto no-scrollbar border-2 border-transparent transition-all"
                             ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="drop(event, '${c.id}')"></div>
                        <button onclick="toggleCollapse('${c.id}')" class="mt-2 text-[7px] font-bold text-slate-300 hover:text-slate-500 uppercase text-center opacity-0 group-hover:opacity-100 transition-opacity">Contraer Columna</button>
                    </div>
                `);
            });
        </script>
    </main>

    <button onclick="askAI()" class="fixed bottom-8 right-8 w-14 h-14 bg-slate-900 dark:bg-green-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-all z-50 group">
        <i class="fas fa-robot text-xl"></i>
        <span class="absolute right-16 bg-slate-800 text-[10px] px-3 py-1 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">PREGUNTAR A IA</span>
    </button>

    <div id="modal-container"></div>

    <script>
        let todosLosPedidos = [];
        let selectedCards = new Set();

        window.onload = () => { pullData(); setInterval(pullData, 30000); };

        async function pullData() {
            try {
                const response = await fetch('/api/pedidos');
                todosLosPedidos = await response.json();
                updateTallerFilter();
                renderPedidos();
            } catch (e) { console.error("Error BBDD:", e); }
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        document.getElementById('zoomSlider').oninput = (e) => {
            document.getElementById('kanbanBoard').style.transform = `scale(${e.target.value})`;
        };

        function updateTallerFilter() {
            const select = document.getElementById('filterTaller');
            const talleres = [...new Set(todosLosPedidos.map(p => p.nombre_taller).filter(Boolean))];
            select.innerHTML = '<option value="todos">TODOS LOS TALLERES</option>';
            talleres.forEach(t => select.innerHTML += `<option value="${t}">${t.toUpperCase()}</option>`);
        }

        function renderPedidos() {
            const taller = document.getElementById('filterTaller').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const vista = document.getElementById('viewSelector').value;

            document.querySelectorAll('.items-container').forEach(el => el.innerHTML = '');
            const counts = { solicitado: 0, desguace: 0, listo: 0, transito: 0, entregado: 0, incidencia: 0 };

            todosLosPedidos.forEach(p => {
                if (taller !== 'todos' && p.nombre_taller !== taller) return;
                if (search && !p.matricula?.toLowerCase().includes(search) && !p.pieza?.toLowerCase().includes(search) && !p.bastidor?.toLowerCase().includes(search)) return;

                const card = document.createElement('div');
                card.className = `card-pieza bg-white dark:bg-slate-800 p-5 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-xl transition-all ${selectedCards.has(p.id.toString()) ? 'selected-card' : ''}`;
                card.draggable = true;
                card.setAttribute('data-id', p.id);
                
                card.onclick = (e) => {
                    if(e.ctrlKey) {
                        card.classList.toggle('selected-card');
                        selectedCards.has(p.id.toString()) ? selectedCards.delete(p.id.toString()) : selectedCards.add(p.id.toString());
                    } else { abrirPopup(p); }
                };

                card.ondragstart = (e) => {
                    const dragIds = selectedCards.size > 0 && selectedCards.has(p.id.toString()) ? Array.from(selectedCards).join(',') : p.id;
                    e.dataTransfer.setData("text/plain", dragIds);
                };

                const badges = [];
                if(p.precio_coste > 400) badges.push('<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[6px] font-black">HIGH MARGIN</span>');
                if(p.prioridad === 'alta') badges.push('<span class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-[6px] font-black">URGENTE</span>');

                const footerExtra = vista === 'avanzada' ? `
                    <div class="mt-3 pt-3 border-t border-slate-50 dark:border-slate-700 flex justify-between text-[7px] font-black text-slate-400 uppercase">
                        <span><i class="fas fa-fingerprint mr-1"></i> ${p.bastidor || 'SIN VIN'}</span>
                        <span class="text-emerald-500">COSTO: ${p.precio_coste || 0}€</span>
                    </div>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-wrap gap-1">${badges.join('')}</div>
                        <span class="text-orange-500 font-black text-[10px]">${p.precio || 0}€</span>
                    </div>
                    <h4 class="font-black text-slate-800 dark:text-white text-[11px] uppercase mb-4 leading-tight">${p.pieza || 'PIEZA'}</h4>
                    <div class="flex justify-between items-end">
                        <div class="text-[8px] font-bold text-slate-400 uppercase">
                            <p>${p.nombre_taller || 'S/N'}</p>
                            <p class="text-[6px] opacity-60 mt-1"><i class="far fa-clock mr-1"></i>${getDaysInStatus(p.updated_at)}</p>
                        </div>
                        <span class="text-[9px] font-black text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-lg border border-blue-100 dark:border-blue-800">${p.matricula || '---'}</span>
                    </div>
                    ${footerExtra}`;

                let estado = (p.estado || 'solicitado').toLowerCase();
                if(estado.includes('verificado')) estado = 'listo';
                
                const target = document.querySelector(`#col-${estado} .items-container`);
                if(target) { target.appendChild(card); counts[estado]++; }
            });

            Object.keys(counts).forEach(key => {
                document.getElementById(`cnt-${key}`).innerText = counts[key];
                const col = document.querySelector(`#col-${key} .kanban-column`);
                counts[key] > 12 ? col.classList.add('bottleneck') : col.classList.remove('bottleneck');
            });
        }

        async function drop(ev, nuevoEstado) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const ids = ev.dataTransfer.getData("text/plain").split(',');
            
            for(let id of ids) {
                const pedido = todosLosPedidos.find(p => p.id == id);
                if(pedido) {
                    pedido.estado = nuevoEstado;
                    await fetch('/api/pedidos/update-status', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id, nuevoEstado })
                    });
                    if(nuevoEstado === 'entregado') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            }
            selectedCards.clear();
            renderPedidos();
        }

        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function dragLeave(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function toggleCollapse(id) { document.getElementById(`col-${id}`).classList.toggle('column-collapsed'); }
        function getDaysInStatus(date) { 
            const diff = Math.floor((new Date() - new Date(date || new Date())) / (1000 * 60 * 60 * 24));
            return diff > 0 ? `${diff}d` : 'Hoy';
        }

        function abrirPopup(p) {
            const modalHtml = `
            <div id="modal-overlay" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-900 rounded-[3rem] w-full max-w-2xl shadow-2xl animate-slide-in overflow-hidden border border-white/10">
                    <div class="flex border-b border-slate-100 dark:border-slate-800 font-black text-[10px] uppercase">
                        <button onclick="switchTab('basica')" id="tab-b" class="flex-1 py-6 bg-slate-50 dark:bg-slate-800 text-blue-600 border-b-2 border-blue-600">General</button>
                        <button onclick="switchTab('avanzada')" id="tab-a" class="flex-1 py-6 text-slate-400">Datos Técnicos & Logs</button>
                    </div>
                    <div class="p-10">
                        <div id="content-basica">
                            <h3 class="text-3xl font-black text-slate-800 dark:text-white uppercase mb-2">${p.pieza}</h3>
                            <p class="text-blue-600 font-black mb-8 italic">${p.matricula} — #${p.id}</p>
                            <div class="grid grid-cols-2 gap-8 text-[10px] font-bold uppercase">
                                <div><p class="text-slate-400 mb-1">Taller</p><p class="dark:text-white text-lg font-black">${p.nombre_taller || '---'}</p></div>
                                <div><p class="text-slate-400 mb-1">Precio Venta</p><p class="text-orange-500 text-lg font-black">${p.precio}€</p></div>
                            </div>
                        </div>
                        <div id="content-avanzada" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl text-[9px]">
                                <div><p class="text-slate-400">BASTIDOR</p><p class="font-black dark:text-white">${p.bastidor || 'N/A'}</p></div>
                                <div><p class="text-slate-400">VALORACIÓN NPS</p><p class="font-black text-orange-500">${p.valoracion_nps || 'PENDIENTE'} ★</p></div>
                            </div>
                            <div class="bg-slate-900 text-[8px] font-mono p-4 rounded-2xl text-green-400 max-h-32 overflow-y-auto">
                                <p>> INICIANDO TRAZABILIDAD...</p>
                                <p class="text-white">> [LOG] PIEZA REGISTRADA EN SISTEMA</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('modal-overlay').remove()" class="w-full mt-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase hover:bg-green-600 transition-all">Cerrar</button>
                    </div>
                </div>
            </div>`;
            document.getElementById('modal-container').innerHTML = modalHtml;
        }

        function switchTab(t) {
            document.getElementById('content-basica').classList.toggle('hidden', t==='avanzada');
            document.getElementById('content-avanzada').classList.toggle('hidden', t==='basica');
            document.getElementById('tab-b').classList.toggle('bg-slate-50', t==='basica');
            document.getElementById('tab-a').classList.toggle('bg-slate-50', t==='avanzada');
        }

        function triggerOCR() { alert("SISTEMA IA: Escaneando imagen en busca de matrículas..."); }
        function askAI() { alert("IA ANALYST: Detectado retraso en 3 piezas de la columna DESGUACE. Se recomienda asignar más agentes."); }
        function showVersionInfo() { alert("RECAMBIO VERDE v3.0\n\n- 6 Columnas Pro\n- Drag & Drop Persistente\n- Modo Noche / Día\n- Zoom Dinámico\n- Multi-selección (Ctrl+Click)\n- Vista Avanzada de Bastidores\n- Sistema de Logs"); }
    </script>
</body>
</html>
