<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Panel de Gestión</title>
    <style>
        .kanban-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; padding: 2rem; }
        .column-header { border-top: 4px solid; padding: 10px 0; margin-bottom: 20px; font-weight: 900; font-size: 10px; text-transform: uppercase; }
        .card-pieza { background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="px-10 pt-10">
        <h1 class="text-3xl font-black uppercase italic">Panel de Gestión</h1>
    </div>

    <div class="kanban-grid">
        <div id="col-solicitado"><div class="column-header border-blue-500">Solicitado <span id="cnt-solicitado">0</span></div><div class="items"></div></div>
        <div id="col-desguace"><div class="column-header border-orange-500">En Desguace <span id="cnt-desguace">0</span></div><div class="items"></div></div>
        <div id="col-listo"><div class="column-header border-indigo-500">Listo <span id="cnt-listo">0</span></div><div class="items"></div></div>
        <div id="col-transito"><div class="column-header border-emerald-500">Tránsito <span id="cnt-transito">0</span></div><div class="items"></div></div>
        <div id="col-entregado"><div class="column-header border-green-500">Entregado <span id="cnt-entregado">0</span></div><div class="items"></div></div>
        <div id="col-incidencia"><div class="column-header border-red-500">Incidencia <span id="cnt-incidencia">0</span></div><div class="items"></div></div>
    </div>

    <script>
        async function pullData() {
            try {
                const res = await fetch('/api/pedidos');
                const data = await res.json();
                
                // Limpiar columnas
                document.querySelectorAll('.items').forEach(el => el.innerHTML = '');
                const counts = { solicitado: 0, desguace: 0, listo: 0, transito: 0, entregado: 0, incidencia: 0 };

                data.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'card-pieza';
                    card.innerHTML = `<p class="text-[10px] font-bold text-blue-600">${p.matricula}</p>
                                      <h4 class="font-black text-xs uppercase">${p.pieza}</h4>
                                      <p class="text-[9px] text-slate-400">${p.nombre_taller || 'S/N'}</p>`;
                    
                    let estado = (p.estado || 'solicitado').toLowerCase().trim();
                    const target = document.querySelector(`#col-${estado} .items`);
                    if(target) {
                        target.appendChild(card);
                        counts[estado]++;
                    }
                });

                // Actualizar contadores
                for (const key in counts) {
                    const el = document.getElementById(`cnt-${key}`);
                    if(el) el.innerText = counts[key];
                }
            } catch (err) { console.error("Error cargando datos:", err); }
        }

        window.onload = pullData;
        setInterval(pullData, 30000);
    </script>
</body>
</html>
