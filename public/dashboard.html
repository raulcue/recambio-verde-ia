<script>
    let todosLosPedidos = [];

    async function pullData() {
        try {
            const response = await fetch('/api/pedidos');
            if (!response.ok) throw new Error('Error en la red');
            todosLosPedidos = await response.json();
            renderPedidos(todosLosPedidos);
        } catch (e) { 
            console.error("Error en sincronización:", e); 
        }
    }

    function renderPedidos(pedidos) {
        document.querySelectorAll('.items-container').forEach(el => el.innerHTML = '');
        const counts = { solicitado: 0, desguace: 0, listo: 0, transito: 0, entregado: 0, incidencia: 0 };

        pedidos.forEach(p => {
            const cardHtml = `
                <div class="card-pieza" onclick='abrirPopup(${JSON.stringify(p)})'>
                    <div class="flex justify-between items-start mb-1 text-[8px] font-black">
                        <span class="text-slate-300 uppercase">${p.numero_pedido || '#'+p.id}</span>
                        <span class="text-orange-500">${p.precio || 0}€</span>
                    </div>
                    <h4 class="font-black text-slate-800 text-[11px] uppercase mb-4 leading-tight">${p.pieza}</h4>
                    <div class="flex justify-between items-center">
                        <p class="text-[8px] font-bold text-slate-400 uppercase italic">${p.nombre_taller || 'S/N'}</p>
                        <span class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-md shadow-sm">${p.matricula || '---'}</span>
                    </div>
                </div>`;
            
            let estado = (p.estado || 'solicitado').toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if(estado.includes('verificado')) estado = 'listo';
            if(estado.includes('transito')) estado = 'transito';

            const target = document.querySelector(`#col-${estado} .items-container`);
            if(target) {
                target.innerHTML += cardHtml;
                counts[estado]++;
            }
        });

        Object.keys(counts).forEach(key => {
            const el = document.getElementById(`cnt-${key}`);
            if(el) el.innerText = counts[key];
        });
    }

    // --- SOLUCIÓN AL ERROR DE LÍNEA 52 ---
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const busqueda = e.target.value.toLowerCase();
            const filtrados = todosLosPedidos.filter(p => 
                (p.matricula && p.matricula.toLowerCase().includes(busqueda)) || 
                (p.pieza && p.pieza.toLowerCase().includes(busqueda))
            );
            renderPedidos(filtrados);
        });
    }

    function abrirPopup(p) {
        const modal = `
            <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
                <div class="bg-white rounded-[3rem] w-full max-w-2xl overflow-hidden shadow-2xl border border-white/20">
                    <div class="flex border-b border-slate-100 font-black text-[10px] uppercase">
                        <button onclick="tab('basica')" id="t-b" class="flex-1 py-6 bg-slate-50 text-blue-600 border-b-2 border-blue-600">Imprescindible</button>
                        <button onclick="tab('avanzada')" id="t-a" class="flex-1 py-6 text-slate-400 hover:bg-slate-50 transition-all">Avanzada</button>
                    </div>
                    <div class="p-10">
                        <div id="c-b" class="space-y-6">
                            <div><label class="text-[9px] font-black text-slate-300 uppercase">Taller</label><p class="text-2xl font-black text-slate-800 uppercase">${p.nombre_taller || 'S/N'}</p></div>
                            <div class="bg-blue-50 p-8 rounded-[2rem]">
                                <label class="text-[9px] font-black text-blue-400 uppercase">Pieza</label>
                                <h3 class="text-3xl font-black text-blue-700 uppercase italic">${p.pieza}</h3>
                                <p class="text-sm font-bold text-blue-400 mt-2">Matrícula: ${p.matricula}</p>
                            </div>
                        </div>
                        <div id="c-a" class="hidden grid grid-cols-2 gap-8">
                            <div><label class="text-[9px] font-black text-slate-300 uppercase">Bastidor</label><p class="font-bold text-slate-700 mt-1">${p.bastidor || '---'}</p></div>
                            <div class="col-span-2 bg-slate-50 p-6 rounded-2xl">
                                <label class="text-[9px] font-black text-slate-300 uppercase">Notas Técnicas</label>
                                <p class="text-xs text-slate-500 italic mt-2">${p.notas_tecnicas || 'Sin notas.'}</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('modal-overlay').remove()" class="w-full mt-10 py-5 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest">Cerrar</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modal);
    }

    function tab(t) {
        document.getElementById('c-b').classList.toggle('hidden', t === 'avanzada');
        document.getElementById('c-a').classList.toggle('hidden', t === 'basica');
        document.getElementById('t-b').className = t === 'basica' ? "flex-1 py-6 bg-slate-50 text-blue-600 border-b-2 border-blue-600" : "flex-1 py-6 text-slate-400";
        document.getElementById('t-a').className = t === 'avanzada' ? "flex-1 py-6 bg-slate-50 text-blue-600 border-b-2 border-blue-600" : "flex-1 py-6 text-slate-400";
    }

    setInterval(pullData, 30000);
    window.onload = pullData;
</script>
