<script>
    let db = [];
    let isPrivate = false;
    const columns = [
        { id: 'solicitado', label: 'Solicitud', color: 'border-slate-300', icon: 'fa-paper-plane' },
        { id: 'desguace', label: 'Localizado', color: 'border-amber-500', icon: 'fa-search-location' },
        { id: 'listo', label: 'En Almacén', color: 'border-purple-600', icon: 'fa-box' },
        { id: 'transito', label: 'Logística', color: 'border-cyan-500', icon: 'fa-truck' },
        { id: 'entregado', label: 'Cerrado', color: 'border-emerald-500', icon: 'fa-check-circle' },
        { id: 'incidencia', label: 'Incidencias', color: 'border-red-600', icon: 'fa-exclamation-triangle' }
    ];

    async function init() {
        await Promise.all([cargarTalleres(), cargarDatos()]);
        const pEst = document.getElementById('p-estado');
        pEst.innerHTML = ''; // Limpiar antes de llenar
        columns.forEach(c => pEst.add(new Option(c.label.toUpperCase(), c.id)));
    }

    async function cargarTalleres() {
        const res = await fetch('/api/talleres');
        const data = await res.json();
        const fT = document.getElementById('filtroTaller');
        const pT = document.getElementById('p-taller');
        data.forEach(t => {
            fT.add(new Option(t.nombre, t.id));
            pT.add(new Option(t.nombre, t.id));
        });
    }

    async function cargarDatos() {
        const tId = document.getElementById('filtroTaller').value;
        const res = await fetch(`/api/pedidos?taller_id=${tId}`);
        if(!res.ok) return;
        db = await res.json();
        renderBoard();
    }

    function renderBoard() {
        const board = document.getElementById('kanbanBoard');
        board.innerHTML = '';
        let globalSum = 0;

        columns.forEach(col => {
            const items = db.filter(p => p.estado === col.id);
            const colSum = items.reduce((a, b) => a + parseFloat(b.precio || 0), 0);
            globalSum += colSum;

            const columnHtml = `
                <div class="kanban-column flex flex-col gap-6">
                    <div class="flex justify-between items-center px-4 border-l-[6px] ${col.color}">
                        <div>
                            <h3 class="text-[11px] font-black uppercase tracking-widest dark:text-white">${col.label}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">${items.length} piezas</p>
                        </div>
                        <span class="total-header-blur text-xs font-black text-blue-600 italic">${colSum.toFixed(0)}€</span>
                    </div>
                    <div class="flex-1 space-y-4 overflow-y-auto custom-scrollbar pr-2" ondragover="event.preventDefault()" ondrop="drop(event, '${col.id}')">
                        ${items.map(p => `
                            <div draggable="true" ondragstart="start(event, ${p.id})" 
                                 onclick='abrirEditar(${JSON.stringify(p)})'
                                 class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 hover:border-blue-500/40 transition-all cursor-pointer group active:scale-95">
                                <div class="flex justify-between mb-4">
                                    <div class="w-8 h-8 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-slate-400 group-hover:text-blue-600">
                                        <i class="fas ${col.icon} text-[10px]"></i>
                                    </div>
                                    <span class="text-[8px] font-bold text-slate-300 tracking-widest">#${p.id}</span>
                                </div>
                                <h4 class="text-xs font-black uppercase dark:text-white leading-tight mb-2 tracking-tighter">${p.pieza}</h4>
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-4">${p.marca_coche || ''} ${p.modelo_coche || '---'}</p>
                                <div class="flex justify-between items-center pt-4 border-t dark:border-slate-800">
                                    <span class="text-[9px] font-black text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-3 py-1 rounded-lg">${p.matricula || 'S/M'}</span>
                                    <span class="text-xs font-black dark:text-white">${p.precio || 0}€</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            board.innerHTML += columnHtml;
        });
        document.getElementById('total-general').innerText = `${globalSum.toLocaleString()}€`;
    }

    function start(e, id) { e.dataTransfer.setData("text", id); }
    
    async function drop(e, nuevoEstado) {
        const id = e.dataTransfer.getData("text");
        const pedido = db.find(x => x.id == id);
        // Enviamos el objeto con los nombres exactos que espera tu server.js
        await fetch('/api/pedidos/update-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                id: id, 
                nuevoEstado: nuevoEstado, 
                pieza: pedido.pieza,
                admin_user: 'Admin (Drag)' 
            })
        });
        cargarDatos();
    }

    function togglePrivacy() {
        isPrivate = !isPrivate;
        document.body.classList.toggle('privacy-active', isPrivate);
        document.getElementById('eye-icon').className = isPrivate ? "fas fa-eye-slash text-xs" : "fas fa-eye text-xs";
    }

    function switchTab(t) {
        ['gen', 'eco', 'tec'].forEach(id => {
            document.getElementById(`tab-${id}`).classList.toggle('hidden', id !== t);
            document.getElementById(`tab-${id}-btn`).classList.toggle('tab-active', id === t);
        });
    }

    function abrirModalNuevo() {
        document.getElementById('form-pedido').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('modal-titulo').innerText = "Nuevo Registro";
        document.getElementById('modal-estado-badge').innerText = "NUEVO";
        document.getElementById('modal').classList.remove('hidden');
        switchTab('gen');
    }

    function abrirEditar(p) {
        document.getElementById('p-id').value = p.id;
        document.getElementById('p-pieza').value = p.pieza || '';
        document.getElementById('p-matricula').value = p.matricula || '';
        document.getElementById('p-marca').value = p.marca_coche || '';
        document.getElementById('p-modelo').value = p.modelo_coche || '';
        document.getElementById('p-taller').value = p.usuario_id || '';
        document.getElementById('p-estado').value = p.estado || 'solicitado';
        document.getElementById('p-precio').value = p.precio || 0;
        document.getElementById('p-coste').value = p.precio_coste || 0;
        document.getElementById('p-proveedor').value = p.proveedor || '';
        document.getElementById('p-referencia').value = p.referencia || '';
        document.getElementById('p-bastidor').value = p.bastidor || '';
        document.getElementById('p-subestado').value = p.sub_estado_incidencia || '';
        document.getElementById('p-notas').value = p.notas_tecnicas || '';
        
        document.getElementById('modal-titulo').innerText = "Editar Registro #" + p.id;
        document.getElementById('modal-estado-badge').innerText = p.estado.toUpperCase();
        document.getElementById('modal').classList.remove('hidden');
        switchTab('gen');
    }

    document.getElementById('form-pedido').onsubmit = async (e) => {
        e.preventDefault();
        
        // MAPEADO EXACTO HACIA TU SERVER.JS
        const data = {
            id: document.getElementById('p-id').value || null,
            pieza: document.getElementById('p-pieza').value,
            matricula: document.getElementById('p-matricula').value,
            marca_coche: document.getElementById('p-marca').value,
            modelo_coche: document.getElementById('p-modelo').value,
            usuario_id: document.getElementById('p-taller').value,
            nuevoEstado: document.getElementById('p-estado').value,
            precio: document.getElementById('p-precio').value || 0,
            precio_coste: document.getElementById('p-coste').value || 0,
            proveedor: document.getElementById('p-proveedor').value,
            bastidor: document.getElementById('p-bastidor').value,
            sub_estado_incidencia: document.getElementById('p-subestado').value,
            notas_tecnicas: document.getElementById('p-notas').value,
            admin_user: 'Admin Root'
        };

        await fetch('/api/pedidos/update-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        cerrarModal(); 
        cargarDatos();
    };

    async function eliminarRegistro() {
        const id = document.getElementById('p-id').value;
        if(!id) return;
        if(confirm("¿Seguro que quieres borrar este registro?")) {
            await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
            cerrarModal(); cargarDatos();
        }
    }

    function filtrar() {
        const q = document.getElementById('buscador').value.toLowerCase();
        document.querySelectorAll('#kanbanBoard .group').forEach(card => {
            card.style.display = card.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        });
    }

    function cerrarModal() { document.getElementById('modal').classList.add('hidden'); }
    window.onload = init;
</script>
