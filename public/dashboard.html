<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Operaciones - Recambio Reciclado IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/js/global.js"></script>
    <style>
        .dark-mode { background-color: #0f172a !important; color: #f8fafc; }
        .dark-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: white; }
        .view-active { background-color: #1e293b !important; color: white !important; shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kanban-col { min-height: calc(100vh - 250px); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-in { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen transition-colors duration-300">

    <div class="p-6 max-w-[1800px] mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-800 uppercase tracking-tighter leading-none">Panel de Control</h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-2">Gestión de inventario y logística</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="bg-slate-200 p-1.5 rounded-2xl flex gap-1 shadow-inner">
                    <button onclick="changeView('compact')" id="btn-compact" class="px-5 py-2 text-[10px] font-black uppercase rounded-xl transition-all">Vista Compacta</button>
                    <button onclick="changeView('extended')" id="btn-extended" class="px-5 py-2 text-[10px] font-black uppercase rounded-xl transition-all">Vista Extendida</button>
                </div>
                <button onclick="document.body.classList.toggle('dark-mode')" class="p-3 bg-white border rounded-2xl hover:bg-slate-100 transition shadow-sm">
                    <i class="fas fa-moon text-slate-600"></i>
                </button>
            </div>
        </div>

        <main class="flex gap-6 overflow-x-auto pb-10" id="kanban-board">
            <script>
                const estados = ["Pedido", "En Desguace", "Listo Envío", "En Tránsito", "Entregado", "Incidencia"];
                estados.forEach((nom, i) => {
                    document.write(`
                        <div class="min-w-[300px] flex-1">
                            <div class="mb-4 flex justify-between items-center px-2">
                                <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest">${nom}</h3>
                                <span id="count-${i+1}" class="bg-slate-200 text-slate-600 text-[9px] font-black px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div id="tasks-${i+1}" class="kanban-col bg-slate-100/50 p-3 rounded-[2.5rem] border-2 border-dashed border-slate-200 space-y-4"></div>
                        </div>`);
                });
            </script>
        </main>
    </div>

    <div id="modalDetalle" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden items-center justify-center z-[200] p-4" onclick="if(event.target === this) cerrarPopup()">
        <div class="bg-white w-full max-w-2xl rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] relative animate-in" onclick="event.stopPropagation()">
            
            <button onclick="cerrarPopup()" class="absolute top-8 right-8 text-slate-300 hover:text-red-500 transition text-3xl z-50">
                <i class="fas fa-times-circle"></i>
            </button>

            <div class="p-10 bg-slate-50 border-b">
                <div class="flex flex-col gap-1 mb-4">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Taller Solicitante</span>
                    <div class="flex items-center gap-2">
                        <select id="pop-taller-id" class="text-[11px] font-black bg-blue-100 text-blue-700 px-4 py-2 rounded-full uppercase outline-none focus:ring-2 focus:ring-blue-400 border-none cursor-pointer flex-grow"></select>
                        <button type="button" onclick="irAEditarTaller()" class="w-9 h-9 flex items-center justify-center bg-white border rounded-full text-slate-400 hover:text-blue-500 transition shadow-sm"><i class="fas fa-pen text-xs"></i></button>
                        <button type="button" onclick="irANuevoTaller()" class="w-9 h-9 flex items-center justify-center bg-slate-800 text-white hover:bg-green-600 rounded-full transition shadow-lg"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                </div>
                <h2 id="pop-pieza-titulo" class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Pieza</h2>
            </div>

            <form id="formEdicion" class="p-10 overflow-y-auto space-y-6">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest">Marca (Ej: VOL filtra Volvo/VW)</label>
                        <input list="marcas-list" id="edit-marca" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="marcas-list"></datalist>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest">Modelo</label>
                        <input list="modelos-list" id="edit-modelo" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="modelos-list"></datalist>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest">Matrícula</label>
                        <input type="text" id="edit-matricula" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest">Nº Bastidor</label>
                        <input type="text" id="edit-bastidor" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest">Notas de Seguimiento</label>
                    <textarea id="edit-notas" rows="3" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-xs focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>

                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="confirmarBorrado()" class="flex-1 bg-red-50 text-red-500 py-5 rounded-3xl font-black uppercase text-[10px] hover:bg-red-500 hover:text-white transition-all shadow-sm">
                        <i class="fas fa-trash-alt mr-2"></i>Eliminar
                    </button>
                    <button type="submit" class="flex-[2] bg-slate-800 text-white py-5 rounded-3xl font-black uppercase text-[10px] tracking-widest hover:bg-green-600 transition-all shadow-xl">
                        Sincronizar Datos
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalConfirm" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-[300] backdrop-blur-sm">
        <div class="bg-white p-12 rounded-[3.5rem] max-w-sm text-center shadow-2xl animate-in">
            <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-6"></i>
            <h3 class="text-xl font-black uppercase text-slate-800">¿Estás seguro?</h3>
            <p class="text-xs text-slate-400 font-bold uppercase mt-3 mb-10">Esta acción no se puede deshacer.</p>
            <div class="flex gap-4">
                <button onclick="document.getElementById('modalConfirm').style.display='none'" class="flex-1 text-[10px] font-black uppercase text-slate-400">Cancelar</button>
                <button onclick="borrarPieza()" class="flex-1 bg-red-600 text-white py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg">Sí, Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        let pedidosActuales = [];
        let viewMode = obtenerPreferenciaVista();

        // Iconos por categoría (ampliable a +100 piezas por palabras clave)
        const CATEGORIAS = {
            faro: { i: 'fa-lightbulb', c: 'text-amber-500', b: 'bg-amber-50' },
            motor: { i: 'fa-microchip', c: 'text-slate-600', b: 'bg-slate-100' },
            puerta: { i: 'fa-door-open', c: 'text-blue-500', b: 'bg-blue-50' },
            paragolpes: { i: 'fa-car-side', c: 'text-emerald-500', b: 'bg-emerald-50' },
            caja: { i: 'fa-gear', c: 'text-purple-500', b: 'bg-purple-50' },
            retrovisor: { i: 'fa-eye', c: 'text-cyan-500', b: 'bg-cyan-50' },
            asiento: { i: 'fa-chair', c: 'text-orange-600', b: 'bg-orange-50' },
            default: { i: 'fa-box-open', c: 'text-slate-400', b: 'bg-slate-50' }
        };

        function getEstilo(nombre) {
            const n = nombre.toLowerCase();
            for (const k in CATEGORIAS) { if (n.includes(k)) return CATEGORIAS[k]; }
            return CATEGORIAS.default;
        }

        async function load() {
            const res = await fetch('/api/pedidos');
            pedidosActuales = await res.json();
            
            // Cargar marcas del sistema (Datalist inteligente)
            const marcas = JSON.parse(localStorage.getItem('lista_marcas') || '["VOLVO", "VOLKSWAGEN", "RIVIAN", "TESLA", "BMW", "TOYOTA"]');
            document.getElementById('marcas-list').innerHTML = marcas.map(m => `<option value="${m}">`).join('');
            
            await cargarTalleres();
            render();
            updateUI();
        }

        async function cargarTalleres() {
            const res = await fetch('/api/usuarios');
            const users = await res.json();
            const talleres = users.filter(u => u.rol === 'taller');
            document.getElementById('pop-taller-id').innerHTML = talleres.map(t => 
                `<option value="${t.id}">${t.nombre_taller || t.email}</option>`).join('');
        }

        function render() {
            document.querySelectorAll('[id^="tasks-"]').forEach(c => c.innerHTML = '');
            const counts = [0,0,0,0,0,0];

            pedidosActuales.forEach(p => {
                counts[p.estado - 1]++;
                const estilo = getEstilo(p.pieza);
                const htmlIcono = viewMode === 'extended' 
                    ? `<div class="w-full h-24 rounded-3xl mb-4 ${estilo.b} flex items-center justify-center"><i class="fas ${estilo.i} ${estilo.c} text-3xl opacity-60"></i></div>` 
                    : '';

                const card = `
                <div data-id="${p.id}" onclick="abrirPopup(${p.id})" class="bg-white p-5 rounded-[2.2rem] border border-slate-200 shadow-sm hover:shadow-xl transition-all cursor-grab active:cursor-grabbing">
                    ${htmlIcono}
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[8px] font-black text-slate-300 uppercase">${p.numero_pedido}</span>
                        <span class="text-[8px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full uppercase">${p.nombre_taller || 'S/N'}</span>
                    </div>
                    <h4 class="font-black text-slate-800 uppercase text-[11px] leading-tight mb-2">${p.pieza}</h4>
                    <div class="flex justify-between items-center border-t border-slate-50 pt-3 text-[9px] font-bold text-slate-400 italic">
                        <span>${p.marca_coche} ${p.modelo_coche}</span>
                        <span class="text-slate-300">${p.matricula || ''}</span>
                    </div>
                </div>`;
                document.getElementById('tasks-' + p.estado).innerHTML += card;
            });
            counts.forEach((c, i) => document.getElementById('count-' + (i+1)).innerText = c);
            initSortable();
        }

        function initSortable() {
            document.querySelectorAll('[id^="tasks-"]').forEach(col => {
                new Sortable(col, {
                    group: 'p', animation: 200, ghostClass: 'opacity-0',
                    onEnd: async (e) => {
                        const id = e.item.getAttribute('data-id');
                        const nest = e.to.id.split('-')[1];
                        await fetch(`/api/pedidos/${id}/estado`, { 
                            method: 'PUT', headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify({estado: nest}) 
                        });
                        load();
                    }
                });
            });
        }

        // Lógica de Taller
        function irAEditarTaller() {
            const id = document.getElementById('pop-taller-id').value;
            window.location.href = `configuracion.html?edit=${id}`;
        }
        function irANuevoTaller() { window.location.href = 'configuracion.html?action=new'; }

        async function abrirPopup(id) {
            await cargarTalleres();
            const p = pedidosActuales.find(x => x.id == id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('pop-pieza-titulo').innerText = p.pieza;
            document.getElementById('pop-taller-id').value = p.usuario_id;
            document.getElementById('edit-marca').value = p.marca_coche || '';
            document.getElementById('edit-modelo').value = p.modelo_coche || '';
            document.getElementById('edit-matricula').value = p.matricula || '';
            document.getElementById('edit-bastidor').value = p.bastidor || '';
            document.getElementById('edit-notas').value = p.notas_tecnicas || '';
            document.getElementById('modalDetalle').style.display = 'flex';
        }

        function cerrarPopup() { document.getElementById('modalDetalle').style.display = 'none'; }

        document.getElementById('formEdicion').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                usuario_id: document.getElementById('pop-taller-id').value,
                marca_coche: document.getElementById('edit-marca').value,
                modelo_coche: document.getElementById('edit-modelo').value,
                matricula: document.getElementById('edit-matricula').value,
                bastidor: document.getElementById('edit-bastidor').value,
                notas_tecnicas: document.getElementById('edit-notas').value
            };
            await fetch(`/api/pedidos/${id}/update`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            cerrarPopup();
            load();
        };

        function confirmarBorrado() { document.getElementById('modalConfirm').style.display = 'flex'; }
        async function borrarPieza() {
            const id = document.getElementById('edit-id').value;
            await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
            document.getElementById('modalConfirm').style.display = 'none';
            cerrarPopup();
            load();
        }

        function changeView(mode) {
            viewMode = mode;
            guardarPreferenciaVista(mode);
            updateUI();
            render();
        }

        function updateUI() {
            document.getElementById('btn-compact').className = `px-5 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${viewMode === 'compact' ? 'view-active bg-white' : 'hover:bg-slate-300'}`;
            document.getElementById('btn-extended').className = `px-5 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${viewMode === 'extended' ? 'view-active bg-white' : 'hover:bg-slate-300'}`;
        }

        window.onkeydown = (e) => { if(e.key === 'Escape') cerrarPopup(); };

        load();
    </script>
</body>
</html>
