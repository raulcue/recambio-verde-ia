<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Recambio Reciclado | Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .privacy-active .blur-data {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }

        .kanban-column {
            min-height: calc(100vh - 250px);
        }

        /* MEJORA 2: Animación del Toast */
        @keyframes slideDownToast { 
            from { transform: translate(-50%, -100%); opacity: 0; } 
            to { transform: translate(-50%, 0); opacity: 1; } 
        }
        .animate-toast { animation: slideDownToast 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 custom-scrollbar">

    <div id="sync-status" class="fixed top-4 right-24 z-[100] flex items-center gap-2 bg-white/90 dark:bg-slate-800/90 px-3 py-1.5 rounded-full shadow-sm border border-slate-200 dark:border-slate-700 backdrop-blur-md">
        <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse"></div>
        <span id="status-text" class="text-[10px] font-black uppercase tracking-widest text-slate-500 dark:text-slate-400">Sincronizado</span>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[110] flex flex-col gap-2 pointer-events-none"></div>

    <nav class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 p-4">
        <div class="max-w-[1600px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                    <i class="fas fa-layer-group fa-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter">LOGÍSTICA <span class="text-blue-600">IA</span></h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest leading-none">Dashboard de Control</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="exportToExcel()" class="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl text-slate-500 transition-all group" title="Exportar a Excel">
                    <i class="fas fa-file-excel group-hover:text-emerald-600 transition-colors"></i>
                </button>
                <button onclick="togglePrivacy()" id="privacyBtn" class="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl text-slate-500 transition-all" title="Modo Privacidad">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl text-slate-500 transition-all">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                <div class="h-6 w-[1px] bg-slate-200 dark:bg-slate-700 mx-2"></div>
                <button onclick="abrirModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-lg shadow-blue-500/25">
                    <i class="fas fa-plus"></i>
                    <span>Nuevo Pedido</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="p-6 max-w-[1600px] mx-auto">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="flex items-center gap-4 bg-white dark:bg-slate-800 p-1.5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-2 px-3 py-2 border-r border-slate-200 dark:border-slate-700">
                    <i class="fas fa-filter text-blue-500 text-xs"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-tighter">Filtros</span>
                </div>
                <div class="flex items-center px-2">
                    <select id="filtro-taller" onchange="cargarDatos()" class="bg-transparent border-none text-sm font-semibold focus:ring-0 cursor-pointer px-4 text-slate-600 dark:text-slate-300">
                        <option value="todos">Todos los Talleres</option>
                    </select>
                </div>
            </div>
            
            <div id="stats" class="flex items-center gap-8 bg-white dark:bg-slate-800 px-8 py-4 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <div class="kanban-column" id="col-solicitado">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                        <h3 class="font-black uppercase text-xs tracking-widest text-slate-500">Solicitado</h3>
                    </div>
                    <span class="count bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="space-y-4" id="cards-solicitado"></div>
            </div>

            <div class="kanban-column" id="col-desguace">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                        <h3 class="font-black uppercase text-xs tracking-widest text-slate-500">En Desguace</h3>
                    </div>
                    <span class="count bg-orange-100 dark:bg-orange-900/30 text-orange-600 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="space-y-4" id="cards-desguace"></div>
            </div>

            <div class="kanban-column" id="col-transito">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <h3 class="font-black uppercase text-xs tracking-widest text-slate-500">En Tránsito</h3>
                    </div>
                    <span class="count bg-blue-100 dark:bg-blue-900/30 text-blue-600 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="space-y-4" id="cards-transito"></div>
            </div>

            <div class="kanban-column" id="col-entregado">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <h3 class="font-black uppercase text-xs tracking-widest text-slate-500">Entregado</h3>
                    </div>
                    <span class="count bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="space-y-4" id="cards-entregado"></div>
            </div>

            <div class="kanban-column" id="col-incidencia">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        <h3 class="font-black uppercase text-xs tracking-widest text-slate-500">Incidencia</h3>
                    </div>
                    <span class="count bg-red-100 dark:bg-red-900/30 text-red-600 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="space-y-4" id="cards-incidencia"></div>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-3xl w-full max-w-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span id="modal-estado-badge" class="bg-blue-100 text-blue-600 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">PEDIDO</span>
                    <h2 id="modal-titulo" class="text-xl font-black">Nuevo Registro</h2>
                </div>
                <button onclick="cerrarModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times-circle fa-xl"></i>
                </button>
            </div>

            <div class="flex border-b border-slate-100 dark:border-slate-700 px-6">
                <button onclick="switchTab('gen')" id="tab-gen" class="px-4 py-4 text-xs font-black uppercase tracking-widest tab-active">General</button>
                <button onclick="switchTab('tec')" id="tab-tec" class="px-4 py-4 text-xs font-black uppercase tracking-widest text-slate-400">Técnico</button>
            </div>

            <div class="p-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <form id="form-pedido" class="space-y-6">
                    <input type="hidden" id="p-id">
                    
                    <div id="content-gen" class="grid grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Nombre de la Pieza</label>
                            <input type="text" id="p-pieza" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Ej: Alternador Bosch 12V">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Matrícula</label>
                            <input type="text" id="p-matricula" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-mono font-bold tracking-tighter">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Taller Asignado</label>
                            <select id="p-taller" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold focus:ring-2 focus:ring-blue-500">
                                </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Marca</label>
                            <input type="text" id="p-marca" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Modelo</label>
                            <input type="text" id="p-modelo" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold">
                        </div>
                    </div>

                    <div id="content-tec" class="hidden grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Estado Actual</label>
                            <select id="p-estado" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-bold text-blue-600 focus:ring-2 focus:ring-blue-500">
                                <option value="solicitado">SOLICITADO</option>
                                <option value="desguace">EN DESGUACE</option>
                                <option value="transito">EN TRÁNSITO</option>
                                <option value="entregado">ENTREGADO</option>
                                <option value="incidencia">INCIDENCIA</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Proveedor</label>
                            <input type="text" id="p-proveedor" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Número de Bastidor</label>
                            <input type="text" id="p-bastidor" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-mono font-bold uppercase tracking-widest">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Precio Venta (€)</label>
                            <input type="number" step="0.01" id="p-precio" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-black text-emerald-600">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Precio Coste (€)</label>
                            <input type="number" step="0.01" id="p-coste" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-black text-red-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Detalle Sub-Estado (Incidencia)</label>
                            <input type="text" id="p-subestado" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold" placeholder="Ej: Retraso mensajería, Pieza defectuosa...">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Notas Técnicas Internas</label>
                            <textarea id="p-notes" rows="4" class="w-full bg-slate-50 dark:bg-slate-900 border-none rounded-2xl px-5 py-4 font-semibold focus:ring-2 focus:ring-blue-500" placeholder="Anotaciones para el equipo de logística..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-8 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                <button onclick="eliminarRegistro()" class="text-red-500 text-xs font-black uppercase tracking-widest hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-xl transition-all">
                    Eliminar
                </button>
                <div class="flex gap-3">
                    <button onclick="cerrarModal()" class="px-6 py-3 text-xs font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">Cancelar</button>
                    <button onclick="guardarCambios()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-blue-500/25">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pedidos = [];
        let talleres = [];

        // MEJORA 2: Función de Toast (Feedback visual)
        function showToast(msj, color = 'blue') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bg = color === 'red' ? 'bg-red-600' : (color === 'green' ? 'bg-emerald-600' : 'bg-blue-600');
            toast.className = `${bg} text-white px-6 py-3 rounded-2xl shadow-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 animate-toast pointer-events-auto`;
            toast.innerHTML = `<i class="fas ${color === 'red' ? 'fa-triangle-exclamation' : 'fa-circle-check'} fa-lg"></i> ${msj}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                toast.style.transition = 'all 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // MEJORAS 1 y 3: Indicador de Sincronización Real-Time
        function updateSyncStatus(online) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if(online) {
                dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse";
                text.innerText = "Sincronizado";
            } else {
                dot.className = "w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_10px_red]";
                text.innerText = "Sin Conexión";
            }
        }

        // Inicialización
        async function init() {
            await cargarTalleres();
            await cargarDatos();
            // Polling cada 30 segundos
            setInterval(cargarDatos, 30000);
        }

        async function cargarTalleres() {
            try {
                const res = await fetch('/api/talleres');
                talleres = await res.json();
                
                const selectFiltro = document.getElementById('filtro-taller');
                const selectModal = document.getElementById('p-taller');
                
                talleres.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.nombre;
                    selectFiltro.appendChild(opt.cloneNode(true));
                    selectModal.appendChild(opt);
                });
            } catch (err) {
                console.error('Error al cargar talleres:', err);
            }
        }

        async function cargarDatos() {
            try {
                const tallerId = document.getElementById('filtro-taller').value;
                const url = tallerId === 'todos' ? '/api/pedidos' : `/api/pedidos?taller_id=${tallerId}`;
                const res = await fetch(url);
                pedidos = await res.json();
                
                updateSyncStatus(true);
                renderKanban();
                renderStats();
            } catch (err) {
                updateSyncStatus(false);
                console.error('Error al cargar datos:', err);
            }
        }

        function renderKanban() {
            const estados = ['solicitado', 'desguace', 'transito', 'entregado', 'incidencia'];
            
            estados.forEach(estado => {
                const container = document.getElementById(`cards-${estado}`);
                const countLabel = document.querySelector(`#col-${estado} .count`);
                const filtrados = pedidos.filter(p => p.estado === estado);
                
                countLabel.innerText = filtrados.length;
                container.innerHTML = '';

                filtrados.forEach(p => {
                    const card = document.createElement('div');
                    card.onclick = () => abrirModal(p.id);
                    card.className = "bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all cursor-pointer group animate-in fade-in slide-in-from-bottom-2 duration-300";
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-[9px] font-black uppercase tracking-tighter text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded-md">
                                ${p.nombre_usuario || 'Taller Desconocido'}
                            </span>
                            <span class="text-[9px] font-bold text-slate-400">#${p.id}</span>
                        </div>
                        <h4 class="font-bold text-sm mb-1 group-hover:text-blue-600 transition-colors">${p.pieza}</h4>
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fas fa-car text-[10px] text-slate-300"></i>
                            <span class="text-[10px] font-bold text-slate-500 uppercase blur-data">${p.marca_coche || ''} ${p.modelo_coche || ''}</span>
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t border-slate-100 dark:border-slate-700">
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] font-black blur-data">${p.precio ? p.precio + '€' : '--'}</span>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-900 px-2 py-1 rounded-lg">
                                <span class="text-[10px] font-mono font-bold tracking-tighter blur-data uppercase">${p.matricula || 'S/M'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function renderStats() {
            const total = pedidos.length;
            const entrega = pedidos.filter(p => p.estado === 'entregado').length;
            const inci = pedidos.filter(p => p.estado === 'incidencia').length;
            const efectividad = total > 0 ? Math.round((entrega / total) * 100) : 0;

            document.getElementById('stats').innerHTML = `
                <div class="flex flex-col items-end">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Total Pedidos</span>
                    <span class="text-xl font-black text-slate-900 dark:text-white leading-none">${total}</span>
                </div>
                <div class="w-[1px] h-8 bg-slate-200 dark:bg-slate-700"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Efectividad</span>
                    <span class="text-xl font-black text-emerald-500 leading-none">${efectividad}%</span>
                </div>
                <div class="w-[1px] h-8 bg-slate-200 dark:bg-slate-700"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Incidencias</span>
                    <span class="text-xl font-black ${inci > 0 ? 'text-red-500' : 'text-slate-400'} leading-none">${inci}</span>
                </div>
            `;
        }

        function switchTab(tab) {
            const cGen = document.getElementById('content-gen');
            const cTec = document.getElementById('content-tec');
            const tGen = document.getElementById('tab-gen');
            const tTec = document.getElementById('tab-tec');

            if (tab === 'gen') {
                cGen.classList.remove('hidden');
                cTec.classList.add('hidden');
                tGen.classList.add('tab-active');
                tTec.classList.remove('tab-active', 'text-slate-400');
                tTec.classList.add('text-slate-400');
            } else {
                cGen.classList.add('hidden');
                cTec.classList.remove('hidden');
                tTec.classList.add('tab-active');
                tGen.classList.remove('tab-active', 'text-slate-400');
                tGen.classList.add('text-slate-400');
            }
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function togglePrivacy() {
            document.body.classList.toggle('privacy-active');
            const btn = document.getElementById('privacyBtn');
            btn.classList.toggle('text-blue-600');
            const isActive = document.body.classList.contains('privacy-active');
            showToast(isActive ? "Privacidad Activada" : "Privacidad Desactivada", isActive ? "blue" : "blue");
        }

        function abrirModal(id = null) {
            const form = document.getElementById('form-pedido');
            form.reset();
            
            if (id) {
                const p = pedidos.find(x => x.id === id);
                document.getElementById('p-id').value = p.id;
                document.getElementById('p-pieza').value = p.pieza;
                document.getElementById('p-matricula').value = p.matricula;
                document.getElementById('p-marca').value = p.marca_coche;
                document.getElementById('p-modelo').value = p.modelo_coche;
                document.getElementById('p-taller').value = p.usuario_id;
                document.getElementById('p-estado').value = p.estado;
                document.getElementById('p-precio').value = p.precio;
                document.getElementById('p-coste').value = p.precio_coste;
                document.getElementById('p-proveedor').value = p.proveedor;
                document.getElementById('p-bastidor').value = p.bastidor;
                document.getElementById('p-subestado').value = p.sub_estado_incidencia;
                document.getElementById('p-notes').value = p.notas_tecnicas;
                
                document.getElementById('modal-titulo').innerText = `Editar Registro #${p.id}`;
                document.getElementById('modal-estado-badge').innerText = p.estado.toUpperCase();
            } else {
                document.getElementById('p-id').value = '';
                document.getElementById('modal-titulo').innerText = "Nuevo Registro";
                document.getElementById('modal-estado-badge').innerText = "NUEVO";
            }
            
            switchTab('gen');
            document.getElementById('modal').classList.remove('hidden');
        }

        function cerrarModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function guardarCambios() {
            const id = document.getElementById('p-id').value;
            const data = {
                id: id ? parseInt(id) : null,
                pieza: document.getElementById('p-pieza').value,
                matricula: document.getElementById('p-matricula').value,
                marca_coche: document.getElementById('p-marca').value,
                modelo_coche: document.getElementById('p-modelo').value,
                usuario_id: document.getElementById('p-taller').value,
                nuevoEstado: document.getElementById('p-estado').value,
                precio: document.getElementById('p-precio').value,
                precio_coste: document.getElementById('p-coste').value,
                proveedor: document.getElementById('p-proveedor').value,
                bastidor: document.getElementById('p-bastidor').value,
                sub_estado_incidencia: document.getElementById('p-subestado').value,
                notas_tecnicas: document.getElementById('p-notes').value,
                admin_user: 'Admin Dashboard'
            };

            try {
                const res = await fetch('/api/pedidos/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast(id ? "Pedido actualizado correctamente" : "Nuevo pedido creado", "green");
                    cerrarModal();
                    await cargarDatos();
                } else {
                    showToast("Error al guardar los cambios", "red");
                }
            } catch (err) {
                showToast("Error crítico de red", "red");
            }
        }

        async function eliminarRegistro() {
            const id = document.getElementById('p-id').value;
            if (!id) return;
            
            if (confirm(`¿Estás seguro de que deseas eliminar el pedido #${id}? Esta acción no se puede deshacer.`)) {
                try {
                    const res = await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast("Registro eliminado con éxito", "red");
                        cerrarModal();
                        await cargarDatos();
                    } else {
                        showToast("No se pudo eliminar el registro", "red");
                    }
                } catch (err) {
                    showToast("Error de conexión al eliminar", "red");
                }
            }
        }

        function exportToExcel() {
            try {
                const ws = XLSX.utils.json_to_sheet(pedidos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
                XLSX.writeFile(wb, "Reporte_Logistica_IA.xlsx");
                showToast("Excel generado con éxito", "green");
            } catch (err) {
                showToast("Error al exportar Excel", "red");
            }
        }

        // Event Listeners
        window.onload = init;

        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                cerrarModal();
            }
        }
    </script>
</body>
</html>
