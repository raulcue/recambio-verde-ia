<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <title>Logística IA - Enterprise Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { darkBg: '#0f172a', cardDark: '#1e293b' }
                }
            }
        };
    </script>
    <style>
        .kanban-column { min-width: 350px; }
        .drag-over { border: 2px dashed #3b82f6 !important; background: rgba(59, 130, 246, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .tab-active { background: #2563eb !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 overflow-hidden font-sans">

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] opacity-0 transition-all duration-500 pointer-events-none">
        <div id="toast-container" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 font-bold text-xs uppercase tracking-widest">
            <i id="toast-icon" class="fas fa-check-circle"></i> <span id="toast-msg">Sincronizado</span>
        </div>
    </div>

    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 px-6 py-3 flex justify-between items-center z-50">
        <div class="flex items-center gap-6">
            <button class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-slate-500">
                <i class="fas fa-th text-lg"></i>
            </button>
            <img src="/assets/logo.png" alt="Logo" class="h-8 dark:brightness-0 dark:invert">
            <div class="h-6 w-[1px] bg-slate-200 dark:bg-slate-700"></div>
            <select id="filtroTaller" onchange="cargarDatos()" class="bg-transparent border-none font-black uppercase text-[10px] tracking-widest outline-none cursor-pointer">
                <option value="todos text-dark">Todos los Talleres</option>
            </select>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end px-4 border-r border-slate-200 dark:border-slate-700 cursor-pointer" onclick="toggleStock()">
                <p class="text-[8px] font-bold text-slate-500 uppercase">Valor Stock</p>
                <div class="flex items-center gap-2">
                    <span id="total-euros" class="text-sm font-black text-emerald-500">0.00€</span>
                    <i id="eye-icon" class="fas fa-eye text-[10px] text-slate-400"></i>
                </div>
            </div>
            <button onclick="toggleDark()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500"><i class="fas fa-moon"></i></button>
            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">RC</div>
        </div>
    </nav>

    <div class="px-8 py-6 bg-white dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-800 flex flex-wrap gap-4 justify-between items-center">
        <div class="relative w-full max-w-lg">
            <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
            <input type="text" id="buscador" oninput="filtrar()" placeholder="Buscar en 24 campos (VIN, Matrícula, Cliente...)" 
                   class="w-full bg-slate-100 dark:bg-slate-800/50 rounded-2xl py-3 pl-12 pr-6 text-xs font-bold outline-none focus:ring-2 ring-blue-500 transition-all">
        </div>
        <button onclick="abrirModal()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all">
            + Nuevo Registro Enterprise
        </button>
    </div>

    <main class="flex gap-6 p-8 overflow-x-auto h-[calc(100vh-180px)] custom-scrollbar" id="kanbanBoard"></main>

    <div id="modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden z-[200] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-5xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden" id="modalContent">
            
            <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-black italic uppercase tracking-tighter">Ficha Logística Pro</h2>
                <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                    <button onclick="switchTab('tab-1')" id="btn-tab-1" class="px-6 py-2 rounded-lg text-[10px] font-bold uppercase transition-all tab-active">Pedido & Coche</button>
                    <button onclick="switchTab('tab-2')" id="btn-tab-2" class="px-6 py-2 rounded-lg text-[10px] font-bold uppercase transition-all text-slate-400">Taller & Cliente</button>
                    <button onclick="switchTab('tab-3')" id="btn-tab-3" class="px-6 py-2 rounded-lg text-[10px] font-bold uppercase transition-all text-slate-400">Logística & Costes</button>
                </div>
            </div>

            <form id="pedido-form" class="p-8 overflow-y-auto custom-scrollbar flex-1">
                <input type="hidden" id="pedido-id">
                
                <div id="tab-1" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="col-span-2"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Pieza</label><input type="text" id="pieza" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold uppercase border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Matrícula</label><input type="text" id="matricula" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold uppercase border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Bastidor (VIN)</label><input type="text" id="bastidor" maxlength="17" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold uppercase border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Marca</label><input type="text" id="marca" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Modelo</label><input type="text" id="modelo" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Motorización</label><input type="text" id="motor" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Año</label><input type="number" id="anyo" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none focus:ring-2 ring-blue-500"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Referencia OEM</label><input type="text" id="ref_oem" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none focus:ring-2 ring-blue-500"></div>
                </div>

                <div id="tab-2" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Nombre Taller</label><input type="text" id="nombre_taller" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Teléfono Taller</label><input type="text" id="tel_taller" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Nombre Cliente Final</label><input type="text" id="cliente_final" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Dirección de Entrega</label><input type="text" id="direccion" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Provincia</label><input type="text" id="provincia" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Email</label><input type="email" id="email" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                </div>

                <div id="tab-3" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Precio Venta (€)</label><input type="number" step="0.01" id="precio" class="w-full bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl outline-none border-none text-blue-600 font-black"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Coste Compra (€)</label><input type="number" step="0.01" id="coste" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Estado Pedido</label>
                        <select id="estado" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none font-bold uppercase text-[10px]">
                            <option value="solicitado">Solicitado</option>
                            <option value="desguace">Desguace</option>
                            <option value="listo">Listo</option>
                            <option value="transito">Tránsito</option>
                            <option value="entregado">Entregado</option>
                            <option value="incidencia">Incidencia</option>
                        </select>
                    </div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Agencia Transporte</label><input type="text" id="agencia" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div class="col-span-2"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Número de Seguimiento (Tracking)</label><input type="text" id="tracking" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></div>
                    <div class="col-span-3"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Notas Técnicas e Incidencias</label><textarea id="notas" rows="3" class="w-full bg-slate-50 dark:bg-slate-800 p-4 rounded-xl outline-none border-none"></textarea></div>
                </div>

                <div class="flex gap-4 mt-10">
                    <button type="button" onclick="cerrarModal()" class="flex-1 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold uppercase text-[10px]">Cancelar</button>
                    <button type="submit" id="btnGuardar" class="flex-1 p-4 bg-blue-600 text-white rounded-xl font-black uppercase text-[10px] shadow-xl shadow-blue-500/20">Sincronizar SQL</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Lógica de Tabs
        function switchTab(tabId) {
            ['tab-1', 'tab-2', 'tab-3'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            ['btn-tab-1', 'btn-tab-2', 'btn-tab-3'].forEach(id => {
                document.getElementById(id).classList.remove('tab-active');
                document.getElementById(id).classList.add('text-slate-400');
            });
            const activeBtn = 'btn-' + tabId;
            document.getElementById(activeBtn).classList.add('tab-active');
            document.getElementById(activeBtn).classList.remove('text-slate-400');
        }

        // Lógica de Persistencia SQL
        async function guardarEnSQL(data) {
            showToast("Conectando con SQL...", "info");
            try {
                const endpoint = data.id ? '/api/pedidos/update' : '/api/pedidos/create';
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if(res.ok) {
                    showToast("Base de Datos Actualizada", "success");
                    cerrarModal();
                    cargarDatos();
                }
            } catch (e) {
                showToast("Error de conexión SQL", "error");
            }
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', '-translate-y-4');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        // ... Resto de lógica de renderizado y filtros (similar a la anterior pero adaptada a los 24 campos)
        
        function abrirModal() {
            document.getElementById('modal').classList.remove('hidden');
            switchTab('tab-1');
        }

        function cerrarModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function toggleDark() {
            document.documentElement.classList.toggle('dark');
        }

        let stockVis = true;
        function toggleStock() {
            stockVis = !stockVis;
            document.getElementById('total-euros').classList.toggle('blur-sm');
        }
    </script>
</body>
</html>
