<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestor de Piezas</title>
    
    <!-- Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Kanban Styles */
        .kanban-column { min-height: 500px; }
        .kanban-item { 
            cursor: move;
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .kanban-item.urgente { border-left-color: #ef4444; }
        .kanban-item.alta { border-left-color: #f59e0b; }
        .kanban-item.media { border-left-color: #3b82f6; }
        .kanban-item.baja { border-left-color: #10b981; }
        
        /* Drag & Drop */
        .dragging { opacity: 0.5; transform: rotate(2deg); }
        .drop-zone { 
            transition: all 0.3s ease;
            min-height: 100px;
        }
        .drop-zone.drag-over { 
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
        }
        
        /* Avatar Menu */
        .avatar-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            min-width: 200px;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 100;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .dark .avatar-menu {
            background: #1f2937;
            border-color: #374151;
        }
        .avatar-menu.show { display: block; }
        
        /* Waffle Menu */
        .waffle-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            width: 320px;
        }
        .dark .waffle-menu {
            background: #1f2937;
            border-color: #374151;
        }
        .waffle-menu.show { display: block; }
        
        /* Language Selector */
        .lang-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 100;
            overflow: hidden;
            min-width: 150px;
            border: 1px solid #e5e7eb;
        }
        .dark .lang-menu {
            background: #1f2937;
            border-color: #374151;
        }
        .lang-menu.show { display: block; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">

    <!-- Header Superior -->
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-4 sticky top-0 z-40">
        <div class="max-w-[1800px] mx-auto flex items-center justify-between">
            
            <!-- Logo y Navegaci칩n -->
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center">
                        <i class="fas fa-tools text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black uppercase tracking-tight">Dashboard Piezas</h1>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Gesti칩n Kanban & Pedidos</p>
                    </div>
                </div>
                
                <!-- Waffle Icon (Roadmap y Navegaci칩n) -->
                <div class="relative">
                    <button onclick="toggleWaffleMenu()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <i class="fas fa-th text-slate-700 dark:text-slate-300"></i>
                    </button>
                    
                    <!-- Waffle Menu -->
                    <div id="waffle-menu" class="waffle-menu">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="font-black text-sm uppercase text-slate-700 dark:text-slate-300">Acceso R치pido</h3>
                        </div>
                        <div class="grid grid-cols-3 gap-1 p-2">
                            <!-- Enlaces del roadmap -->
                            <a href="dashboard.html" class="flex flex-col items-center p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mb-2">
                                    <i class="fas fa-columns text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Dashboard</span>
                            </a>
                            
                            <a href="desguaces.html" id="roadmap-desguaces" class="flex flex-col items-center p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center mb-2">
                                    <i class="fas fa-warehouse text-green-600 dark:text-green-400"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Desguaces</span>
                            </a>
                            
                            <a href="usuarios.html" class="flex flex-col items-center p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mb-2">
                                    <i class="fas fa-users text-purple-600 dark:text-purple-400"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Usuarios</span>
                            </a>
                            
                            <!-- M치s enlaces seg칰n necesidad -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controles Derecha -->
            <div class="flex items-center gap-3">
                <!-- Bot칩n Nuevo Pedido -->
                <button onclick="abrirModalPieza()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 rounded-xl font-black text-xs uppercase tracking-wider transition-all shadow-lg active:scale-95">
                    <i class="fas fa-plus mr-2"></i> Nuevo Pedido
                </button>
                
                <!-- Idioma -->
                <div class="relative">
                    <button onclick="toggleLangMenu()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <i class="fas fa-globe text-slate-700 dark:text-slate-300"></i>
                    </button>
                    
                    <!-- Language Menu -->
                    <div id="lang-menu" class="lang-menu">
                        <button onclick="cambiarIdioma('es')" class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">游쀯릖 Espa침ol</span>
                        </button>
                        <button onclick="cambiarIdioma('en')" class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">游섫릖 English</span>
                        </button>
                        <button onclick="cambiarIdioma('fr')" class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">游游 Fran칞ais</span>
                        </button>
                    </div>
                </div>
                
                <!-- Notificaciones -->
                <button class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors relative">
                    <i class="fas fa-bell text-slate-700 dark:text-slate-300"></i>
                    <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-black rounded-full w-4 h-4 flex items-center justify-center">3</span>
                </button>
                
                <!-- Avatar y Usuario (COPIADO DE LANDING) -->
                <div class="relative">
                    <button onclick="toggleAvatarMenu()" class="flex items-center gap-3 p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <div id="user-avatar" class="w-9 h-9 rounded-full flex items-center justify-center font-black text-sm text-white shadow-lg border-2 border-white dark:border-slate-800">
                            <!-- Se llena con JS -->
                        </div>
                        <div class="text-left">
                            <p id="user-name" class="text-xs font-black text-slate-700 dark:text-slate-300"></p>
                            <p id="user-rol" class="text-[10px] text-slate-500 uppercase font-bold tracking-widest"></p>
                        </div>
                    </button>
                    
                    <!-- Avatar Menu (COPIADO DE LANDING) -->
                    <div id="avatar-menu" class="avatar-menu">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700">
                            <p class="text-xs font-black text-slate-700 dark:text-slate-300" id="menu-user-name"></p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest" id="menu-user-rol"></p>
                        </div>
                        <div class="p-2">
                            <a href="perfil.html" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <i class="fas fa-user text-slate-500 w-4"></i>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Mi Perfil</span>
                            </a>
                            <a href="configuracion.html" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <i class="fas fa-cog text-slate-500 w-4"></i>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Configuraci칩n</span>
                            </a>
                            <div class="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                            <button onclick="cerrarSesion()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 transition-colors">
                                <i class="fas fa-power-off"></i>
                                <span class="text-xs font-bold">Cerrar Sesi칩n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Filtros -->
    <div class="max-w-[1800px] mx-auto p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm">
            <div class="flex flex-wrap items-center gap-4">
                <!-- Filtro por Taller -->
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Taller</label>
                    <select id="filtro-taller" onchange="filtrarKanban()" class="bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500 min-w-[180px]">
                        <option value="">TODOS LOS TALLERES</option>
                    </select>
                </div>
                
                <!-- Filtro por Estado -->
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Estado</label>
                    <select id="filtro-estado" onchange="filtrarKanban()" class="bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">TODOS LOS ESTADOS</option>
                        <option value="solicitud">Solicitud</option>
                        <option value="proceso">En Proceso</option>
                        <option value="finalizado">Finalizado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                
                <!-- Filtro por Prioridad -->
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Prioridad</label>
                    <select id="filtro-prioridad" onchange="filtrarKanban()" class="bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">TODAS LAS PRIORIDADES</option>
                        <option value="urgente">Urgente</option>
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                
                <!-- Buscador -->
                <div class="flex-1 min-w-[300px]">
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Buscar</label>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="buscador" onkeyup="filtrarKanban()" placeholder="Buscar por t칤tulo, marca, modelo..." class="w-full pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Bot칩n Limpiar -->
                <div class="self-end">
                    <button onclick="limpiarFiltros()" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl text-xs font-bold transition-colors">
                        <i class="fas fa-times mr-2"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <main class="max-w-[1800px] mx-auto p-4">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Columna: Solicitud -->
            <div class="kanban-column bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <h2 class="text-sm font-black uppercase">Solicitud</h2>
                        <span id="count-solicitud" class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-black px-2 py-1 rounded-lg">0</span>
                    </div>
                    <button onclick="abrirModalPieza()" class="text-blue-600 hover:text-blue-700">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="columna-solicitud" class="drop-zone space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Las tarjetas se cargan aqu칤 -->
                </div>
            </div>
            
            <!-- Columna: En Proceso -->
            <div class="kanban-column bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <h2 class="text-sm font-black uppercase">En Proceso</h2>
                        <span id="count-proceso" class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-black px-2 py-1 rounded-lg">0</span>
                    </div>
                </div>
                <div id="columna-proceso" class="drop-zone space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Las tarjetas se cargan aqu칤 -->
                </div>
            </div>
            
            <!-- Columna: Finalizado -->
            <div class="kanban-column bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <h2 class="text-sm font-black uppercase">Finalizado</h2>
                        <span id="count-finalizado" class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-black px-2 py-1 rounded-lg">0</span>
                    </div>
                </div>
                <div id="columna-finalizado" class="drop-zone space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Las tarjetas se cargan aqu칤 -->
                </div>
            </div>
            
            <!-- Columna: Cancelado -->
            <div class="kanban-column bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <h2 class="text-sm font-black uppercase">Cancelado</h2>
                        <span id="count-cancelado" class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-black px-2 py-1 rounded-lg">0</span>
                    </div>
                </div>
                <div id="columna-cancelado" class="drop-zone space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Las tarjetas se cargan aqu칤 -->
                </div>
            </div>
            
        </div>
    </main>

    <!-- Modal para Nueva Pieza -->
    <div id="modal-pieza" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800">
                <h3 class="text-lg font-black uppercase">Nuevo Pedido / Pieza</h3>
                <button onclick="cerrarModalPieza()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="form-pieza" class="p-6 space-y-4">
                <!-- T칤tulo y Descripci칩n -->
                <div>
                    <label class="text-xs font-black uppercase text-slate-500 mb-2 block">T칤tulo del Pedido *</label>
                    <input type="text" id="p-titulo" required class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                </div>
                
                <div>
                    <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Descripci칩n</label>
                    <textarea id="p-descripcion" rows="2" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold resize-none"></textarea>
                </div>
                
                <!-- Datos del Veh칤culo -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Marca</label>
                        <input type="text" id="p-marca" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Modelo</label>
                        <input type="text" id="p-modelo" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Matr칤cula</label>
                        <input type="text" id="p-matricula" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">A침o</label>
                        <input type="number" id="p-a침o" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                    </div>
                </div>
                
                <!-- FIXED: Cliente y Taller - Ahora se cargan desde /api/usuarios -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Cliente *</label>
                        <select id="p-cliente" required class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Taller *</label>
                        <select id="p-taller" required class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                            <option value="">Seleccionar taller</option>
                        </select>
                    </div>
                </div>
                
                <!-- Prioridad y Fecha -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Prioridad</label>
                        <select id="p-prioridad" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-black uppercase text-slate-500 mb-2 block">Fecha L칤mite</label>
                        <input type="date" id="p-fecha-limite" class="w-full p-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none text-sm font-bold">
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="cerrarModalPieza()" class="flex-1 py-3 font-black uppercase text-xs text-slate-500 hover:text-slate-700">Cancelar</button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-black uppercase text-xs shadow-lg hover:from-blue-700 hover:to-indigo-700 transition-all">
                        Guardar Pedido
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2"></div>

    <script>
        // Variables globales
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let pedidos = [];
        let talleres = [];
        let clientes = [];
        let dragElement = null;

        // Inicializaci칩n
        async function init() {
            if (!user.id) {
                window.location.href = 'index.html';
                return;
            }

            // Configurar usuario en header
            document.getElementById('user-avatar').innerText = user.iniciales || '--';
            document.getElementById('user-avatar').className += ` ${user.rol === 'admin' ? 'bg-red-700' : 'bg-blue-700'} text-white`;
            document.getElementById('user-name').innerText = user.nombre || 'Usuario';
            document.getElementById('user-rol').innerText = user.rol === 'admin' ? 'ADMINISTRADOR' : 'TALLER';
            document.getElementById('menu-user-name').innerText = user.nombre || 'Usuario';
            document.getElementById('menu-user-rol').innerText = user.rol === 'admin' ? 'ADMINISTRADOR' : 'TALLER';

            // Ocultar desguaces en roadmap si es taller
            if (user.rol === 'taller') {
                document.getElementById('roadmap-desguaces').classList.add('hidden');
            }

            // Cargar datos
            await cargarTalleres();
            await cargarClientes();
            await cargarPedidos();
        }

        // FIXED: Cargar talleres desde /api/usuarios?rol=taller
        async function cargarTalleres() {
            try {
                const res = await fetch('/api/usuarios?rol=taller');
                if (!res.ok) throw new Error('Error cargando talleres');
                
                talleres = await res.json();
                const selectTaller = document.getElementById('filtro-taller');
                const selectTallerModal = document.getElementById('p-taller');
                
                // Limpiar opciones existentes (excepto la primera)
                while (selectTaller.options.length > 1) selectTaller.remove(1);
                while (selectTallerModal.options.length > 1) selectTallerModal.remove(1);
                
                // Agregar talleres
                talleres.forEach(t => {
                    if (t.id && t.nombre) {
                        const option = new Option(t.nombre, t.id);
                        const optionModal = new Option(t.nombre, t.id);
                        selectTaller.add(option);
                        selectTallerModal.add(optionModal.cloneNode(true));
                    }
                });
            } catch (error) {
                console.error('Error cargando talleres:', error);
                showToast('Error cargando lista de talleres', 'error');
            }
        }

        // FIXED: Cargar clientes desde /api/usuarios
        async function cargarClientes() {
            try {
                const res = await fetch('/api/usuarios');
                if (!res.ok) throw new Error('Error cargando clientes');
                
                clientes = await res.json();
                const selectCliente = document.getElementById('p-cliente');
                
                // Limpiar opciones existentes (excepto la primera)
                while (selectCliente.options.length > 1) selectCliente.remove(1);
                
                // Agregar clientes
                clientes.forEach(c => {
                    if (c.id && c.nombre) {
                        const option = new Option(c.nombre, c.id);
                        selectCliente.add(option);
                    }
                });
            } catch (error) {
                console.error('Error cargando clientes:', error);
                showToast('Error cargando lista de clientes', 'error');
            }
        }

        // Cargar pedidos
        async function cargarPedidos() {
            try {
                const res = await fetch('/api/pedidos');
                if (!res.ok) throw new Error('Error cargando pedidos');
                
                pedidos = await res.json();
                renderKanban();
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                showToast('Error cargando pedidos', 'error');
            }
        }

        // Renderizar Kanban
        function renderKanban(pedidosFiltrados = pedidos) {
            // Limpiar columnas
            ['solicitud', 'proceso', 'finalizado', 'cancelado'].forEach(estado => {
                document.getElementById(`columna-${estado}`).innerHTML = '';
            });
            
            // Contadores
            const contadores = { solicitud: 0, proceso: 0, finalizado: 0, cancelado: 0 };
            
            // Crear tarjetas
            pedidosFiltrados.forEach(pedido => {
                const tarjeta = crearTarjeta(pedido);
                document.getElementById(`columna-${pedido.estado}`).appendChild(tarjeta);
                contadores[pedido.estado]++;
            });
            
            // Actualizar contadores
            Object.keys(contadores).forEach(estado => {
                document.getElementById(`count-${estado}`).innerText = contadores[estado];
            });
        }

        // Crear tarjeta HTML
        function crearTarjeta(pedido) {
            const div = document.createElement('div');
            div.className = `kanban-item p-4 rounded-xl bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 ${pedido.prioridad}`;
            div.draggable = true;
            div.id = `pedido-${pedido.id}`;
            div.setAttribute('data-id', pedido.id);
            div.setAttribute('data-estado', pedido.estado);
            
            // Prioridad color
            const prioridadClases = {
                urgente: 'urgente',
                alta: 'alta', 
                media: 'media',
                baja: 'baja'
            };
            
            const prioridadTexto = {
                urgente: 'URGENTE',
                alta: 'ALTA',
                media: 'MEDIA',
                baja: 'BAJA'
            };
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h4 class="text-sm font-black text-slate-800 dark:text-slate-100 mb-1">${pedido.titulo}</h4>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mb-2">${pedido.descripcion || 'Sin descripci칩n'}</p>
                    </div>
                    <span class="px-2 py-1 text-[10px] font-black uppercase rounded-lg ${pedido.prioridad === 'urgente' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' : 
                        pedido.prioridad === 'alta' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                        pedido.prioridad === 'baja' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                        'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300'}">
                        ${prioridadTexto[pedido.prioridad] || 'MEDIA'}
                    </span>
                </div>
                
                <div class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                    <p class="truncate"><i class="fas fa-car mr-2"></i>${pedido.marca || 'N/A'} ${pedido.modelo || ''}</p>
                    <p class="truncate"><i class="fas fa-hashtag mr-2"></i>${pedido.matricula || 'Sin matr칤cula'}</p>
                </div>
                
                <div class="flex justify-between items-center pt-3 border-t border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-xs font-black text-blue-600 dark:text-blue-400">
                            ${pedido.cliente_iniciales || 'CL'}
                        </div>
                        <span class="text-[10px] font-bold text-slate-600 dark:text-slate-400">${pedido.cliente_nombre || 'Cliente'}</span>
                    </div>
                    <div class="text-[10px] text-slate-500">
                        ${new Date(pedido.created_at).toLocaleDateString()}
                    </div>
                </div>
            `;
            
            // Eventos drag
            div.addEventListener('dragstart', dragStart);
            div.addEventListener('dragend', dragEnd);
            
            return div;
        }

        // Drag & Drop Functions
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function dragStart(ev) {
            dragElement = ev.target;
            setTimeout(() => {
                ev.target.classList.add('dragging');
            }, 0);
            
            // Guardar datos en dataTransfer
            ev.dataTransfer.setData('text/plain', ev.target.getAttribute('data-id'));
            ev.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd(ev) {
            ev.target.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        // FIXED: Funci칩n drop que actualiza el estado en el servidor
        async function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const pedidoId = ev.dataTransfer.getData('text/plain');
            const nuevoEstado = ev.currentTarget.parentElement.id.replace('columna-', '');
            
            if (!pedidoId || !nuevoEstado) return;
            
            // Encontrar el pedido
            const pedido = pedidos.find(p => p.id == pedidoId);
            if (!pedido || pedido.estado === nuevoEstado) return;
            
            try {
                // Actualizar en servidor
                const res = await fetch(`/api/pedidos/${pedidoId}/estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });
                
                if (!res.ok) throw new Error('Error actualizando estado');
                
                const pedidoActualizado = await res.json();
                
                // Actualizar localmente
                const index = pedidos.findIndex(p => p.id == pedidoId);
                pedidos[index] = pedidoActualizado;
                
                // Re-renderizar
                renderKanban();
                showToast('Estado actualizado correctamente', 'success');
                
            } catch (error) {
                console.error('Error en drop:', error);
                showToast('Error actualizando estado', 'error');
                // Revertir visualmente
                renderKanban();
            }
        }

        // Filtrado
        function filtrarKanban() {
            const filtroTaller = document.getElementById('filtro-taller').value;
            const filtroEstado = document.getElementById('filtro-estado').value;
            const filtroPrioridad = document.getElementById('filtro-prioridad').value;
            const busqueda = document.getElementById('buscador').value.toLowerCase();
            
            let filtrados = pedidos;
            
            if (filtroTaller) {
                filtrados = filtrados.filter(p => p.taller_id == filtroTaller);
            }
            
            if (filtroEstado) {
                filtrados = filtrados.filter(p => p.estado === filtroEstado);
            }
            
            if (filtroPrioridad) {
                filtrados = filtrados.filter(p => p.prioridad === filtroPrioridad);
            }
            
            if (busqueda) {
                filtrados = filtrados.filter(p => 
                    p.titulo.toLowerCase().includes(busqueda) ||
                    p.descripcion?.toLowerCase().includes(busqueda) ||
                    p.marca?.toLowerCase().includes(busqueda) ||
                    p.modelo?.toLowerCase().includes(busqueda) ||
                    p.matricula?.toLowerCase().includes(busqueda)
                );
            }
            
            renderKanban(filtrados);
        }

        function limpiarFiltros() {
            document.getElementById('filtro-taller').value = '';
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-prioridad').value = '';
            document.getElementById('buscador').value = '';
            renderKanban();
        }

        // Modal Pieza
        function abrirModalPieza() {
            document.getElementById('form-pieza').reset();
            document.getElementById('modal-pieza').classList.remove('hidden');
            // Establecer fecha m칤nima como hoy
            document.getElementById('p-fecha-limite').min = new Date().toISOString().split('T')[0];
        }

        function cerrarModalPieza() {
            document.getElementById('modal-pieza').classList.add('hidden');
        }

        // FIXED: Guardar nueva pieza con persistencia correcta
        document.getElementById('form-pieza').onsubmit = async (e) => {
            e.preventDefault();
            
            const payload = {
                titulo: document.getElementById('p-titulo').value,
                descripcion: document.getElementById('p-descripcion').value,
                cliente_id: document.getElementById('p-cliente').value,
                taller_id: document.getElementById('p-taller').value,
                estado: 'solicitud',
                prioridad: document.getElementById('p-prioridad').value,
                marca: document.getElementById('p-marca').value,
                modelo: document.getElementById('p-modelo').value,
                matricula: document.getElementById('p-matricula').value,
                a침o: document.getElementById('p-a침o').value ? parseInt(document.getElementById('p-a침o').value) : null,
                fecha_limite: document.getElementById('p-fecha-limite').value || null
            };
            
            try {
                const res = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Error del servidor');
                }
                
                const nuevoPedido = await res.json();
                
                // Agregar a lista local
                pedidos.unshift(nuevoPedido);
                
                // Cerrar modal y actualizar
                cerrarModalPieza();
                renderKanban();
                showToast('Pedido creado correctamente', 'success');
                
            } catch (error) {
                console.error('Error guardando pedido:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        };

        // Men칰s
        function toggleAvatarMenu() {
            document.getElementById('avatar-menu').classList.toggle('show');
        }

        function toggleWaffleMenu() {
            document.getElementById('waffle-menu').classList.toggle('show');
        }

        function toggleLangMenu() {
            document.getElementById('lang-menu').classList.toggle('show');
        }

        // Cerrar men칰s al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('avatar-menu').classList.remove('show');
                document.getElementById('waffle-menu').classList.remove('show');
                document.getElementById('lang-menu').classList.remove('show');
            }
        });

        // Cambiar idioma
        function cambiarIdioma(lang) {
            // Aqu칤 ir칤a la l칩gica de internacionalizaci칩n
            showToast(`Idioma cambiado a ${lang.toUpperCase()}`, 'success');
            document.getElementById('lang-menu').classList.remove('show');
        }

        // Cerrar sesi칩n
        function cerrarSesion() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            toast.className = `${colors[type] || 'bg-blue-600'} text-white px-6 py-4 rounded-xl font-bold text-xs uppercase shadow-2xl animate-slide-in`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Inicializar
        init();
    </script>
</body>
</html>
