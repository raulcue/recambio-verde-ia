<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ProfitPulse ¬∑ Revenue Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
tailwind.config = { darkMode: 'class' }
</script>

<style>
body { font-family: 'Inter', sans-serif; }
canvas { max-height: 320px; }
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 flex flex-col min-h-screen">

<div id="header-slot"></div>

<main class="flex-grow px-6 py-6 space-y-6 max-w-7xl mx-auto w-full">

<!-- HEADER -->
<div class="flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-bold">üìà ProfitPulse</h1>
    <p class="text-xs text-slate-400 uppercase">Revenue Intelligence Engine</p>
  </div>

  <div class="flex items-center gap-2 text-sm">
    <span id="db-dot" class="w-3 h-3 rounded-full bg-slate-400"></span>
    <span id="db-status">Desconectado</span>
  </div>
</div>

<!-- EXPLICACI√ìN -->
<section class="bg-white dark:bg-slate-900 rounded-xl shadow p-4 text-sm space-y-2">
  <div class="flex items-center gap-2 font-semibold">
    <i class="fa-solid fa-circle-info text-blue-500"></i>
    C√≥mo se calcula la comisi√≥n
  </div>
  <ul class="list-disc pl-6 text-slate-600 dark:text-slate-300">
    <li><strong>GGR = Precio ‚Äì Precio Coste</strong></li>
    <li><strong>Comisi√≥n = 1% del GGR</strong></li>
    <li>Si el GGR ‚â§ 0 o inv√°lido ‚Üí <strong>se aplica m√≠nimo 1,50 ‚Ç¨</strong></li>
    <li>M√°ximo por pedido ‚Üí <strong>3,50 ‚Ç¨</strong></li>
    <li>Redondeo ‚Üí <strong>siempre al alza</strong></li>
  </ul>
</section>

<!-- FILTROS -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-3">
  <select id="filterYear" class="p-2 rounded border dark:border-slate-700"></select>
  <select id="filterMonth" class="p-2 rounded border dark:border-slate-700">
    <option value="">Todos los meses</option>
  </select>
  <select id="filterWorkshop" class="p-2 rounded border dark:border-slate-700"></select>
  <button onclick="resetFilters()" class="p-2 rounded bg-slate-200 dark:bg-slate-800">Reset</button>
</section>

<!-- KPIS -->
<section id="kpis" class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm"></section>

<!-- GR√ÅFICOS -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl">
    <h3 class="font-semibold mb-2">üìä Comisi√≥n por Mes</h3>
    <canvas id="chart-month"></canvas>
  </div>

  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl">
    <h3 class="font-semibold mb-2">üìà Comisi√≥n Anual</h3>
    <canvas id="chart-year"></canvas>
  </div>

  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl md:col-span-2">
    <h3 class="font-semibold mb-2">üîÆ Forecast de Comisi√≥n</h3>
    <canvas id="chart-forecast"></canvas>
  </div>
</section>

<!-- TABLA -->
<section class="bg-white dark:bg-slate-900 rounded-xl shadow p-4 overflow-x-auto">
<table class="min-w-full text-sm">
<thead class="border-b dark:border-slate-700">
<tr>
<th>ID</th>
<th>Fecha</th>
<th>Taller</th>
<th>Precio</th>
<th>Coste</th>
<th>GGR</th>
<th>Comisi√≥n</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>

<!-- PAGINACI√ìN -->
<div class="flex justify-between items-center mt-3">
  <button onclick="prevPage()">‚¨ÖÔ∏è</button>
  <div id="page-info"></div>
  <button onclick="nextPage()">‚û°Ô∏è</button>
</div>
</section>

</main>

<div id="footer-slot"></div>

<script>
let RAW=[], FILTERED=[];
let currentPage=1;
const pageSize=10;
let charts={};

async function loadLayout(){
  const html = await fetch('/dashboard.html').then(r=>r.text());
  const tmp=document.createElement('div');
  tmp.innerHTML=html;
  tmp.querySelector('header') && document.getElementById('header-slot').append(tmp.querySelector('header'));
  tmp.querySelector('footer') && document.getElementById('footer-slot').append(tmp.querySelector('footer'));
}

function calcularComision(precio,coste){
  const ggr = precio - coste;
  let c = (!isFinite(ggr) || ggr<=0) ? 1.5 : ggr*0.01;
  c = Math.min(c,3.5);
  c = Math.ceil(c*100)/100;
  return { ggr, comision:c };
}

function enrich(data){
  return data.map(p=>{
    const precio=+p.precio||0;
    const coste=+p.precio_coste||0;
    const fecha = new Date(p.fecha || Date.now());
    const {ggr,comision}=calcularComision(precio,coste);
    return {...p,precio,coste,ggr,comision,fecha};
  });
}

function renderKPIs(data){
  const sum = k => data.reduce((a,b)=>a+(b[k]||0),0);
  const avg = k => data.length?sum(k)/data.length:0;

  const kpis=[
    ['Pedidos',data.length],
    ['Ingresos',sum('precio').toFixed(2)+'‚Ç¨'],
    ['Coste',sum('coste').toFixed(2)+'‚Ç¨'],
    ['GGR',sum('ggr').toFixed(2)+'‚Ç¨'],
    ['Comisi√≥n Total',sum('comision').toFixed(2)+'‚Ç¨'],
    ['Comisi√≥n Media',avg('comision').toFixed(2)+'‚Ç¨']
  ];

  const el=document.getElementById('kpis');
  el.innerHTML='';
  kpis.forEach(k=>{
    el.innerHTML+=`
      <div class="p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-900">
        <div class="text-xs text-slate-400">${k[0]}</div>
        <div class="font-bold text-xl">${k[1]}</div>
      </div>`;
  });
}

function paginate(data){
  const start=(currentPage-1)*pageSize;
  return data.slice(start,start+pageSize);
}

function renderTable(){
  const tbody=document.getElementById('table-body');
  tbody.innerHTML='';
  paginate(FILTERED).forEach(p=>{
    tbody.innerHTML+=`
      <tr class="border-b dark:border-slate-800">
        <td>${p.id||'-'}</td>
        <td>${p.fecha.toISOString().slice(0,10)}</td>
        <td>${p.taller||'‚Äî'}</td>
        <td>${p.precio.toFixed(2)}</td>
        <td>${p.coste.toFixed(2)}</td>
        <td>${p.ggr.toFixed(2)}</td>
        <td class="font-semibold">${p.comision.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById('page-info').innerText =
    `P√°gina ${currentPage} / ${Math.ceil(FILTERED.length/pageSize) || 1}`;
}

function groupBy(data,fn){
  return data.reduce((a,b)=>{
    const k=fn(b);
    a[k]=(a[k]||0)+b.comision;
    return a;
  },{});
}

function renderCharts(data){
  const byMonth = groupBy(data,p=>p.fecha.getMonth()+1);
  const byYear  = groupBy(data,p=>p.fecha.getFullYear());

  charts.month?.destroy();
  charts.year?.destroy();
  charts.forecast?.destroy();

  charts.month=new Chart(chart-month,{
    type:'bar',
    data:{labels:Object.keys(byMonth),datasets:[{label:'‚Ç¨',data:Object.values(byMonth)}]}
  });

  charts.year=new Chart(chart-year,{
    type:'bar',
    data:{labels:Object.keys(byYear),datasets:[{label:'‚Ç¨',data:Object.values(byYear)}]}
  });

  const months = Object.values(byMonth);
  const avg = months.reduce((a,b)=>a+b,0)/(months.length||1);
  charts.forecast=new Chart(chart-forecast,{
    type:'line',
    data:{
      labels:['Actual','+1M','+2M','+3M'],
      datasets:[{label:'Forecast ‚Ç¨',data:[avg,avg*1.05,avg*1.1,avg*1.15]}]
    }
  });
}

function applyFilters(){
  const y=filterYear.value;
  const m=filterMonth.value;
  const t=filterWorkshop.value;

  FILTERED = RAW.filter(p=>
    (!y || p.fecha.getFullYear()==y) &&
    (!m || p.fecha.getMonth()+1==m) &&
    (!t || p.taller==t)
  );

  currentPage=1;
  refresh();
}

function refresh(){
  renderKPIs(FILTERED);
  renderCharts(FILTERED);
  renderTable();
}

function prevPage(){ if(currentPage>1){currentPage--;renderTable();}}
function nextPage(){ if(currentPage<Math.ceil(FILTERED.length/pageSize)){currentPage++;renderTable();}}

function resetFilters(){
  filterYear.value='';
  filterMonth.value='';
  filterWorkshop.value='';
  applyFilters();
}

async function loadData(){
  try{
    const res=await fetch('/api/pedidos');
    RAW=enrich(await res.json());
    FILTERED=[...RAW];

    // filtros din√°micos
    const years=[...new Set(RAW.map(p=>p.fecha.getFullYear()))];
    filterYear.innerHTML='<option value="">Todos los a√±os</option>'+years.map(y=>`<option>${y}</option>`).join('');

    filterMonth.innerHTML+=[1,2,3,4,5,6,7,8,9,10,11,12].map(m=>`<option value="${m}">${m}</option>`).join('');

    const talleres=[...new Set(RAW.map(p=>p.taller).filter(Boolean))];
    filterWorkshop.innerHTML='<option value="">Todos los talleres</option>'+talleres.map(t=>`<option>${t}</option>`).join('');

    db-dot.className='w-3 h-3 rounded-full bg-emerald-500';
    db-status.innerText='Conectado';

    refresh();
  }catch(e){
    db-dot.className='w-3 h-3 rounded-full bg-red-500';
    db-status.innerText='Error conexi√≥n';
  }
}

filterYear.onchange=applyFilters;
filterMonth.onchange=applyFilters;
filterWorkshop.onchange=applyFilters;

loadLayout();
loadData();
</script>

</body>
</html>
