<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ProfitPulse ¬∑ Revenue Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
tailwind.config = { darkMode: 'class' }
</script>

<style>
body { font-family: 'Inter', sans-serif; }
canvas { max-height: 300px; }
.suspicious { background: rgba(250,204,21,0.15); }
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 flex flex-col min-h-screen">

<div id="header-slot"></div>

<main class="flex-grow px-6 py-6 space-y-6 max-w-7xl mx-auto w-full">

<!-- HEADER -->
<div class="flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-bold">üìà ProfitPulse</h1>
    <p class="text-xs text-slate-400 uppercase">Revenue Intelligence Engine</p>
  </div>

  <div class="flex items-center gap-2 text-sm">
    <span id="db-dot" class="w-3 h-3 rounded-full bg-slate-400"></span>
    <span id="db-status">Desconectado</span>
  </div>
</div>

<!-- CONFIGURACI√ìN -->
<section class="bg-white dark:bg-slate-900 rounded-xl p-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
  <div>
    <label class="text-xs text-slate-400">%</label>
    <input id="cfgPercent" type="number" value="1" step="0.1" class="w-full p-2 rounded border dark:border-slate-700"/>
  </div>

  <div>
    <label class="text-xs text-slate-400">M√≠nimo (‚Ç¨)</label>
    <input id="cfgMin" type="number" value="1.5" step="0.1" class="w-full p-2 rounded border dark:border-slate-700"/>
  </div>

  <div class="flex items-end">
    <div class="text-xs text-slate-500">
      Cambios aplican instant√°neamente
    </div>
  </div>
</section>

<!-- KPIS -->
<section id="kpis" class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm"></section>

<!-- GR√ÅFICOS -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl">
    <h3 class="font-semibold mb-2">üìä Comisi√≥n mensual</h3>
    <canvas id="chart-month"></canvas>
  </div>

  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl">
    <h3 class="font-semibold mb-2">üìà Comisi√≥n anual</h3>
    <canvas id="chart-year"></canvas>
  </div>

  <div class="bg-white dark:bg-slate-900 p-4 rounded-xl md:col-span-2">
    <h3 class="font-semibold mb-2">üîÆ Forecast + escenarios</h3>
    <canvas id="chart-forecast"></canvas>
  </div>
</section>

<!-- TABLA -->
<section class="bg-white dark:bg-slate-900 rounded-xl shadow p-4 overflow-x-auto">
<table class="min-w-full text-sm">
<thead class="border-b dark:border-slate-700">
<tr>
<th>ID</th>
<th>Fecha</th>
<th>Taller</th>
<th>Precio</th>
<th>Coste</th>
<th>GGR</th>
<th>Comisi√≥n</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>

<div class="flex justify-between items-center mt-3">
  <button onclick="prevPage()">‚¨ÖÔ∏è</button>
  <div id="page-info"></div>
  <button onclick="nextPage()">‚û°Ô∏è</button>
</div>
</section>

</main>

<div id="footer-slot"></div>

<script>
let RAW=[], FILTERED=[];
let charts={};
let currentPage=1;
const pageSize=10;

let CFG = {
  percent: 1,
  min: 1.5
};

async function loadLayout(){
  const html = await fetch('/dashboard.html').then(r=>r.text());
  const tmp=document.createElement('div');
  tmp.innerHTML=html;
  tmp.querySelector('header') && header-slot.append(tmp.querySelector('header'));
  tmp.querySelector('footer') && footer-slot.append(tmp.querySelector('footer'));
}

function calcular(precio,coste){
  const ggr = precio - coste;
  let com = (!isFinite(ggr) || ggr<=0)
    ? CFG.min
    : ggr * (CFG.percent/100);

  com = Math.min(com,3.5);
  com = Math.ceil(com*100)/100;

  return { ggr, com };
}

function enrich(data){
  return data.map(p=>{
    const precio = Number(p.precio);
    const coste  = Number(p.precio_coste);
    const fecha  = new Date(p.fecha || Date.now());

    const invalid = !isFinite(precio) || !isFinite(coste);
    const {ggr,com} = calcular(precio||0,coste||0);

    return {...p, precio, coste, fecha, ggr, com, invalid};
  });
}

function renderKPIs(data){
  const sum = k => data.reduce((a,b)=>a+(b[k]||0),0);
  const avg = k => data.length?sum(k)/data.length:0;

  const suspicious = data.filter(d=>d.invalid).length;

  const kpis=[
    ['Pedidos',data.length],
    ['Comisi√≥n Total',sum('com').toFixed(2)+'‚Ç¨'],
    ['GGR Total',sum('ggr').toFixed(2)+'‚Ç¨'],
    ['Comisi√≥n Media',avg('com').toFixed(2)+'‚Ç¨'],
    ['Pedidos sospechosos',suspicious],
    ['% en m√≠nimo', (data.filter(d=>d.ggr<=0).length/data.length*100||0).toFixed(1)+'%']
  ];

  const el=document.getElementById('kpis');
  el.innerHTML='';
  kpis.forEach(k=>{
    el.innerHTML+=`
      <div class="p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-900">
        <div class="text-xs text-slate-400">${k[0]}</div>
        <div class="font-bold text-xl">${k[1]}</div>
      </div>`;
  });
}

function paginate(data){
  const start=(currentPage-1)*pageSize;
  return data.slice(start,start+pageSize);
}

function renderTable(){
  const tbody=document.getElementById('table-body');
  tbody.innerHTML='';

  paginate(FILTERED).forEach(p=>{
    tbody.innerHTML+=`
      <tr class="border-b dark:border-slate-800 ${p.invalid?'suspicious':''}"
          title="${p.invalid?'Dato incompleto: posible manipulaci√≥n o error':''}">
        <td>${p.id||'-'}</td>
        <td>${p.fecha.toISOString().slice(0,10)}</td>
        <td>${p.taller||'‚Äî'}</td>
        <td>${isFinite(p.precio)?p.precio.toFixed(2):'‚Äî'}</td>
        <td>${isFinite(p.coste)?p.coste.toFixed(2):'‚Äî'}</td>
        <td>${p.ggr.toFixed(2)}</td>
        <td class="font-semibold">${p.com.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById('page-info').innerText =
    `P√°gina ${currentPage} / ${Math.ceil(FILTERED.length/pageSize)||1}`;
}

function groupBy(data,fn){
  return data.reduce((a,b)=>{
    const k=fn(b);
    a[k]=(a[k]||0)+b.com;
    return a;
  },{});
}

function renderCharts(data){
  const byMonth = groupBy(data,p=>p.fecha.getMonth()+1);
  const byYear  = groupBy(data,p=>p.fecha.getFullYear());

  charts.month?.destroy();
  charts.year?.destroy();
  charts.forecast?.destroy();

  charts.month=new Chart(chart-month,{
    type:'bar',
    data:{labels:Object.keys(byMonth),datasets:[{label:'‚Ç¨',data:Object.values(byMonth)}]}
  });

  charts.year=new Chart(chart-year,{
    type:'bar',
    data:{labels:Object.keys(byYear),datasets:[{label:'‚Ç¨',data:Object.values(byYear)}]}
  });

  const base = Object.values(byMonth).reduce((a,b)=>a+b,0)/(Object.keys(byMonth).length||1);
  charts.forecast=new Chart(chart-forecast,{
    type:'line',
    data:{
      labels:['Base','Best','Worst'],
      datasets:[{
        label:'Estimaci√≥n ‚Ç¨',
        data:[base,base*1.1,base*0.9]
      }]
    }
  });
}

function refresh(){
  renderKPIs(FILTERED);
  renderCharts(FILTERED);
  renderTable();
}

function prevPage(){ if(currentPage>1){currentPage--;renderTable();}}
function nextPage(){ if(currentPage<Math.ceil(FILTERED.length/pageSize)){currentPage++;renderTable();}}

async function loadData(){
  try{
    const res=await fetch('/api/pedidos');
    RAW=enrich(await res.json());
    FILTERED=[...RAW];

    db-dot.className='w-3 h-3 rounded-full bg-emerald-500';
    db-status.innerText='Conectado';

    refresh();
  }catch(e){
    db-dot.className='w-3 h-3 rounded-full bg-red-500';
    db-status.innerText='Error conexi√≥n';
  }
}

cfgPercent.oninput = e => { CFG.percent = Number(e.target.value)||1; RAW=enrich(RAW); FILTERED=[...RAW]; refresh(); };
cfgMin.oninput     = e => { CFG.min = Number(e.target.value)||1.5; RAW=enrich(RAW); FILTERED=[...RAW]; refresh(); };

loadLayout();
loadData();
</script>

</body>
</html>
