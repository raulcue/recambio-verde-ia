<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Financial Intelligence Recambio Reciclado | ProfitPulse Analytics Engine</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config = { darkMode: 'class' }</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
body { font-family: 'Inter', sans-serif; }
.glass-card { background:white;border:1px solid #f1f5f9;border-radius:2rem; }
.dark .glass-card { background:#0f172a;border-color:#1e293b; }
.tooltip { position: relative; cursor: help; }
.tooltip:hover::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    background: #0f172a;
    color: white;
    padding: 8px 10px;
    font-size: 11px;
    border-radius: 8px;
    white-space: nowrap;
    z-index: 50;
}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">

<div id="app-header"></div>

<main class="flex-grow max-w-7xl mx-auto px-6 mt-10 pb-24 space-y-10">

<!-- ================= TITLE ================= -->
<div>
    <h1 class="text-2xl font-black uppercase">Financial Intelligence
        <span class="text-blue-600 italic">Recambio Reciclado</span>
    </h1>
    <p class="text-xs font-bold text-slate-400 uppercase">ProfitPulse Analytics Engine</p>
</div>

<!-- ================= AJUSTES AVANZADOS ================= -->
<div class="glass-card p-6 grid grid-cols-1 md:grid-cols-5 gap-4">
    <div>
        <label class="text-xs font-bold">% Comisión</label>
        <input id="cfg-comision" type="number" step="0.1" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>
    <div>
        <label class="text-xs font-bold">Mínimo (€)</label>
        <input id="cfg-minimo" type="number" step="0.1" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>
    <div>
        <label class="text-xs font-bold">Máximo (€)</label>
        <input id="cfg-maximo" type="number" step="0.1" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>
    <div>
        <label class="text-xs font-bold">Simulador Precio</label>
        <input id="sim-precio" type="number" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>
    <div>
        <label class="text-xs font-bold">Simulador Coste</label>
        <input id="sim-coste" type="number" class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>

    <div class="md:col-span-5 flex gap-3">
        <button onclick="saveConfig()" class="flex-1 bg-blue-600 text-white rounded p-2 font-bold">
            Guardar Ajustes
        </button>
        <button onclick="runSimulator()" class="flex-1 bg-emerald-600 text-white rounded p-2 font-bold">
            Simular Comisión
        </button>
        <div id="sim-result" class="flex-1 text-sm font-black flex items-center"></div>
    </div>
</div>

<!-- ================= KPIS ================= -->
<div class="grid grid-cols-1 md:grid-cols-6 gap-4">
    <div class="glass-card p-5 tooltip" data-tip="Suma total de precios de venta">
        <div class="text-xs">Ventas</div><div id="kpi-ventas" class="text-xl font-black">0€</div>
    </div>
    <div class="glass-card p-5 tooltip" data-tip="Precio - Coste acumulado">
        <div class="text-xs">Beneficio Bruto</div><div id="kpi-bruto" class="text-xl font-black">0€</div>
    </div>
    <div class="glass-card p-5 tooltip" data-tip="Comisiones aplicadas según reglas">
        <div class="text-xs">Comisión</div><div id="kpi-comision" class="text-xl font-black">0€</div>
    </div>
    <div class="glass-card p-5 tooltip" data-tip="Bruto - Comisión">
        <div class="text-xs">Beneficio Neto</div><div id="kpi-neto" class="text-xl font-black">0€</div>
    </div>
    <div class="glass-card p-5 tooltip" data-tip="% pedidos con precio válido">
        <div class="text-xs">Ratio</div><div id="kpi-ratio" class="text-xl font-black">–</div>
    </div>
    <div class="glass-card p-5 tooltip" data-tip="Margen medio por pedido">
        <div class="text-xs">Margen Medio</div><div id="kpi-margen-medio" class="text-xl font-black">–</div>
    </div>
</div>

<!-- ================= ALERTAS ================= -->
<div id="alerts" class="glass-card p-5 hidden"></div>

<!-- ================= CHARTS ================= -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="glass-card p-6">
        <h2 class="font-black mb-2">Ventas por Taller</h2>
        <canvas id="chartVentas"></canvas>
    </div>
    <div class="glass-card p-6">
        <h2 class="font-black mb-2">Incidencias por Taller</h2>
        <canvas id="chartIncidencias"></canvas>
    </div>
</div>

<!-- ================= TABLA PEDIDOS ================= -->
<div class="glass-card p-6 overflow-auto">
    <h2 class="font-black mb-3">Detalle de Pedidos</h2>
    <table class="w-full text-xs">
        <thead class="border-b">
            <tr>
                <th>ID</th>
                <th>Taller</th>
                <th>Precio</th>
                <th>Coste</th>
                <th>Margen</th>
                <th>Comisión</th>
                <th>Neto</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="tabla-pedidos"></tbody>
    </table>
</div>

</main>

<div id="app-footer"></div>

<script>
let chartVentas, chartIncidencias;

let config = JSON.parse(localStorage.getItem('profitpulse_config')) || {
    comision: 1.5,
    minimo: 1.5,
    maximo: 3
};

document.getElementById('cfg-comision').value = config.comision;
document.getElementById('cfg-minimo').value = config.minimo;
document.getElementById('cfg-maximo').value = config.maximo;

function saveConfig(){
    config.comision = Number(cfg-comision.value);
    config.minimo = Number(cfg-minimo.value);
    config.maximo = Number(cfg-maximo.value);
    localStorage.setItem('profitpulse_config', JSON.stringify(config));
    cargarStats();
}

function runSimulator(){
    const precio = Number(sim-precio.value||0);
    const coste = Number(sim-coste.value||0);
    const margen = precio-coste;
    let fee = margen*(config.comision/100);
    fee = Math.max(fee, config.minimo);
    fee = Math.min(fee, config.maximo);
    sim-result.innerText = `Comisión simulada: ${fee.toFixed(2)}€`;
}

// ---------------- INIT ----------------
window.addEventListener('DOMContentLoaded', cargarStats);

// ---------------- LOAD DATA ----------------
async function cargarStats(){
    const res = await fetch('/api/pedidos', { cache:'no-store' });
    const pedidos = await res.json();

    const metrics = calcularKPIs(pedidos);
    renderKPIs(metrics);
    renderAlerts(metrics.alerts);
    renderTabla(pedidos);

    const talleres = aggregateByTaller(pedidos);
    renderCharts(talleres);
}

// ---------------- KPI ENGINE ----------------
function calcularKPIs(pedidos){
    let ventas=0, bruto=0, comision=0, neto=0;
    let conPrecio=0;
    const alerts=[];

    pedidos.forEach(p=>{
        const precio = Number(p.precio||0);
        const coste = Number(p.precio_coste||0);

        if(precio===0) alerts.push(`Pedido #${p.id} sin precio`);
        if(coste===0) alerts.push(`Pedido #${p.id} sin coste`);

        if(precio>0){
            ventas+=precio;
            conPrecio++;

            const margen = precio-coste;
            bruto+=margen;

            let fee = margen*(config.comision/100);
            fee = Math.max(fee, config.minimo);
            fee = Math.min(fee, config.maximo);

            comision+=fee;
            neto += (margen-fee);

            if(margen<0) alerts.push(`Pedido #${p.id} con margen negativo`);
        }
    });

    return {
        ventas, bruto, comision, neto,
        margenMedio: conPrecio ? (bruto/conPrecio) : 0,
        ratio: pedidos.length ? ((conPrecio/pedidos.length)*100).toFixed(1) : 0,
        alerts
    };
}

function renderKPIs(m){
    kpi-ventas.innerText = `${m.ventas.toFixed(0)}€`;
    kpi-bruto.innerText = `${m.bruto.toFixed(0)}€`;
    kpi-comision.innerText = `${m.comision.toFixed(0)}€`;
    kpi-neto.innerText = `${m.neto.toFixed(0)}€`;
    kpi-ratio.innerText = `${m.ratio}%`;
    kpi-margen-medio.innerText = `${m.margenMedio.toFixed(0)}€`;
}

// ---------------- TABLE ----------------
function renderTabla(pedidos){
    const tbody = document.getElementById('tabla-pedidos');
    tbody.innerHTML='';

    pedidos.forEach(p=>{
        const precio = Number(p.precio||0);
        const coste = Number(p.precio_coste||0);
        const margen = precio-coste;
        let fee = margen*(config.comision/100);
        fee = Math.max(fee, config.minimo);
        fee = Math.min(fee, config.maximo);
        const neto = margen-fee;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nombre_usuario||'-'}</td>
            <td>${precio}</td>
            <td>${coste}</td>
            <td>${margen.toFixed(1)}</td>
            <td>${fee.toFixed(1)}</td>
            <td>${neto.toFixed(1)}</td>
            <td>${p.estado}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ---------------- ALERTS ----------------
function renderAlerts(alerts){
    const box = document.getElementById('alerts');
    if(!alerts.length){ box.classList.add('hidden'); return; }

    box.classList.remove('hidden');
    box.innerHTML = `<h3 class="font-black mb-2">⚠️ Alertas</h3>` +
        alerts.slice(0,12).map(a=>`<div class="text-xs text-red-500">• ${a}</div>`).join('');
}

// ---------------- AGGREGATION ----------------
function aggregateByTaller(pedidos){
    const map={};

    pedidos.forEach(p=>{
        const t = p.nombre_usuario || 'Sin Taller';
        if(!map[t]) map[t]={ventas:0, incidencias:0};

        const precio = Number(p.precio||0);
        map[t].ventas += precio;

        if(p.estado==='incidencia') map[t].incidencias++;
    });

    return map;
}

// ---------------- CHARTS ----------------
function renderCharts(data){
    const labels = Object.keys(data);
    const ventas = labels.map(l=>data[l].ventas);
    const incidencias = labels.map(l=>data[l].incidencias);

    if(chartVentas) chartVentas.destroy();
    if(chartIncidencias) chartIncidencias.destroy();

    chartVentas = new Chart(chartVentas = new Chart(document.getElementById('chartVentas'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Ventas €', data:ventas }]},
        options:{ responsive:true }
    }));

    chartIncidencias = new Chart(document.getElementById('chartIncidencias'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Incidencias', data:incidencias }]},
        options:{ responsive:true }
    });
}
</script>

<script>
fetch('/partials/header.html').then(r=>r.text()).then(h=>app-header.innerHTML=h);
fetch('/partials/footer.html').then(r=>r.text()).then(h=>app-footer.innerHTML=h);
</script>

</body>
</html>
