<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Financial Intelligence Recambio Reciclado | ProfitPulse Analytics Engine</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config = { darkMode: 'class' }</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
body { font-family: 'Inter', sans-serif; }

.glass-card {
    background:white;
    border:1px solid #f1f5f9;
    border-radius:1.8rem;
}
.dark .glass-card { background:#0f172a;border-color:#1e293b; }

.tooltip { position: relative; cursor: pointer; }
.tooltip:hover::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 130%;
    left: 50%;
    transform: translateX(-50%);
    background: #020617;
    color: white;
    padding: 8px 10px;
    font-size: 11px;
    border-radius: 8px;
    white-space: nowrap;
    z-index: 50;
}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">

<!-- HEADER -->
<div id="app-header"></div>

<!-- BOTÓN AJUSTES -->
<button onclick="toggleSettings()"
        class="fixed bottom-6 right-6 z-50 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-blue-700 transition-all">
    <i class="fas fa-sliders"></i>
</button>

<!-- PANEL AJUSTES -->
<div id="settings-panel"
     class="hidden fixed bottom-24 right-6 w-96 glass-card p-5 shadow-2xl z-50 space-y-3">

    <h3 class="font-black text-sm uppercase">⚙️ Ajustes de Comisión</h3>

    <div>
        <label class="text-xs font-bold">% Comisión</label>
        <input id="cfg-comision" type="number" step="0.1"
               class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>

    <div>
        <label class="text-xs font-bold">Mínimo (€)</label>
        <input id="cfg-minimo" type="number" step="0.1"
               class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>

    <div>
        <label class="text-xs font-bold">Máximo (€)</label>
        <input id="cfg-maximo" type="number" step="0.1"
               class="w-full p-2 rounded bg-slate-100 dark:bg-slate-800">
    </div>

    <button onclick="saveConfig()"
            class="w-full bg-blue-600 text-white rounded p-2 font-bold">
        Guardar Ajustes
    </button>
</div>

<!-- CONTENIDO -->
<main class="flex-grow max-w-screen-2xl mx-auto px-4 xl:px-8 mt-8 pb-24 space-y-10">

<!-- TITLE -->
<div>
    <h1 class="text-2xl font-black uppercase">
        Financial Intelligence
        <span class="text-blue-600 italic">Recambio Reciclado</span>
    </h1>
    <p class="text-xs font-bold text-slate-400 uppercase">ProfitPulse Analytics Engine</p>
</div>

<!-- KPIS -->
<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-6 gap-4">

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Ventas</div>
            <div class="tooltip" data-tip="Suma total de precios de venta">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-ventas" class="text-xl font-black">0€</div>
    </div>

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Beneficio Bruto</div>
            <div class="tooltip" data-tip="Precio de venta menos precio de coste acumulado">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-bruto" class="text-xl font-black">0€</div>
    </div>

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Comisión</div>
            <div class="tooltip" data-tip="Comisión aplicada según % , mínimo y máximo configurados">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-comision" class="text-xl font-black">0€</div>
    </div>

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Beneficio Neto</div>
            <div class="tooltip" data-tip="Beneficio bruto menos comisiones">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-neto" class="text-xl font-black">0€</div>
    </div>

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Ratio</div>
            <div class="tooltip" data-tip="% de pedidos con precio válido">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-ratio" class="text-xl font-black">–</div>
    </div>

    <div class="glass-card p-5">
        <div class="flex justify-between items-center">
            <div class="text-xs">Margen Medio</div>
            <div class="tooltip" data-tip="Beneficio bruto dividido entre pedidos con precio">
                <i class="fas fa-circle-info text-slate-400 hover:text-blue-500"></i>
            </div>
        </div>
        <div id="kpi-margen-medio" class="text-xl font-black">–</div>
    </div>

</div>

<!-- ALERTAS -->
<div id="alerts" class="glass-card p-5 hidden"></div>

<!-- CHARTS -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <div class="glass-card p-6">
        <h2 class="font-black mb-2">Ventas por Taller</h2>
        <canvas id="chartVentas"></canvas>
    </div>
    <div class="glass-card p-6">
        <h2 class="font-black mb-2">Incidencias por Taller</h2>
        <canvas id="chartIncidencias"></canvas>
    </div>
</div>

</main>

<!-- FOOTER -->
<div id="app-footer"></div>

<script>
let chartVentas = null;
let chartIncidencias = null;

let config = JSON.parse(localStorage.getItem('profitpulse_config')) || {
    comision: 1.5,
    minimo: 1.5,
    maximo: 3
};

// ---------------- SETTINGS ----------------
function toggleSettings(){
    const panel = document.getElementById('settings-panel');
    panel.classList.toggle('hidden');
}

function saveConfig(){
    config.comision = Number(document.getElementById('cfg-comision').value);
    config.minimo   = Number(document.getElementById('cfg-minimo').value);
    config.maximo   = Number(document.getElementById('cfg-maximo').value);
    localStorage.setItem('profitpulse_config', JSON.stringify(config));
    cargarStats();
}

// ---------------- INIT ----------------
window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('cfg-comision').value = config.comision;
    document.getElementById('cfg-minimo').value   = config.minimo;
    document.getElementById('cfg-maximo').value   = config.maximo;
    cargarStats();
});

// ---------------- LOAD DATA ----------------
async function cargarStats(){
    const res = await fetch('/api/pedidos', { cache:'no-store' });
    const pedidos = await res.json();

    const metrics = calcularKPIs(pedidos);
    renderKPIs(metrics);
    renderAlerts(metrics.alerts);

    const talleres = aggregateByTaller(pedidos);
    renderCharts(talleres);
}

// ---------------- KPI ENGINE ----------------
function calcularKPIs(pedidos){
    let ventas=0, bruto=0, comision=0, neto=0;
    let conPrecio=0;
    const alerts=[];

    pedidos.forEach(p=>{
        const precio = Number(p.precio||0);
        const coste  = Number(p.precio_coste||0);

        if(precio===0) alerts.push(`Pedido #${p.id} sin precio`);
        if(coste===0)  alerts.push(`Pedido #${p.id} sin coste`);

        if(precio>0){
            ventas += precio;
            conPrecio++;

            const margen = precio - coste;
            bruto += margen;

            let fee = margen * (config.comision/100);
            fee = Math.max(fee, config.minimo);
            fee = Math.min(fee, config.maximo);

            comision += fee;
            neto += (margen - fee);

            if(margen < 0) alerts.push(`Pedido #${p.id} con margen negativo`);
        }
    });

    return {
        ventas, bruto, comision, neto,
        margenMedio: conPrecio ? (bruto/conPrecio) : 0,
        ratio: pedidos.length ? ((conPrecio/pedidos.length)*100).toFixed(1) : 0,
        alerts
    };
}

function renderKPIs(m){
    document.getElementById('kpi-ventas').innerText        = `${m.ventas.toFixed(0)}€`;
    document.getElementById('kpi-bruto').innerText         = `${m.bruto.toFixed(0)}€`;
    document.getElementById('kpi-comision').innerText      = `${m.comision.toFixed(0)}€`;
    document.getElementById('kpi-neto').innerText          = `${m.neto.toFixed(0)}€`;
    document.getElementById('kpi-ratio').innerText         = `${m.ratio}%`;
    document.getElementById('kpi-margen-medio').innerText  = `${m.margenMedio.toFixed(0)}€`;
}

// ---------------- ALERTS ----------------
function renderAlerts(alerts){
    const box = document.getElementById('alerts');
    if(!alerts.length){ box.classList.add('hidden'); return; }

    box.classList.remove('hidden');
    box.innerHTML =
        `<h3 class="font-black mb-2">⚠️ Alertas</h3>` +
        alerts.slice(0,10).map(a=>`<div class="text-xs text-red-500">• ${a}</div>`).join('');
}

// ---------------- AGGREGATION ----------------
function aggregateByTaller(pedidos){
    const map={};
    pedidos.forEach(p=>{
        const t = p.nombre_usuario || 'Sin Taller';
        if(!map[t]) map[t]={ventas:0, incidencias:0};
        const precio = Number(p.precio||0);
        map[t].ventas += precio;
        if(p.estado==='incidencia') map[t].incidencias++;
    });
    return map;
}

// ---------------- CHARTS ----------------
function renderCharts(data){
    const labels = Object.keys(data);
    const ventas = labels.map(l=>data[l].ventas);
    const incidencias = labels.map(l=>data[l].incidencias);

    if(chartVentas) chartVentas.destroy();
    if(chartIncidencias) chartIncidencias.destroy();

    chartVentas = new Chart(document.getElementById('chartVentas'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Ventas €', data:ventas }]},
        options:{ responsive:true }
    });

    chartIncidencias = new Chart(document.getElementById('chartIncidencias'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Incidencias', data:incidencias }]},
        options:{ responsive:true }
    });
}
</script>

<script>
fetch('/partials/header.html')
    .then(r=>r.text())
    .then(h=>document.getElementById('app-header').innerHTML = h);

fetch('/partials/footer.html')
    .then(r=>r.text())
    .then(h=>document.getElementById('app-footer').innerHTML = h);
</script>

</body>
</html>
