<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipo y Talleres - Logística IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { extend: { colors: { darkBg: '#0f172a', cardDark: '#1e293b' } } }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        
        .modal-active { display: flex !important; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.05); }
        .dark .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.1); }

        .waffle-container { position: relative; padding-bottom: 15px; margin-bottom: -15px; } 
        .waffle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; width: 280px; }
        .waffle-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 10px; border-radius: 12px; transition: all 0.2s; text-decoration: none; }
        .waffle-item:hover { background: rgba(37, 99, 235, 0.1); transform: translateY(-2px); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <nav class="bg-white/80 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800 px-6 py-4 flex justify-between items-center sticky top-0 z-[100] backdrop-blur-md">
        <div class="flex items-center gap-4">
            <a href="landing.html" class="flex items-center gap-2">
                <div class="w-8 h-8 bg-orange-600 rounded-lg flex items-center justify-center shadow-lg shadow-orange-500/20">
                    <i class="fas fa-users-cog text-white text-xs"></i>
                </div>
                <h1 class="font-black text-xs uppercase tracking-tighter italic dark:text-white">Panel <span class="text-orange-600">Workshops</span></h1>
            </a>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 border-r border-slate-200 dark:border-slate-700 pr-6">
                <button onclick="document.documentElement.classList.toggle('dark')" class="w-10 h-10 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-500 flex items-center justify-center hover:text-orange-500 transition-colors">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block text-yellow-500"></i>
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div id="avatar-container" class="relative group cursor-pointer">
                    <div id="user-initials" class="w-10 h-10 bg-slate-800 text-white rounded-full flex items-center justify-center font-black text-xs shadow-lg ring-2 ring-white dark:ring-slate-800">
                        ??
                    </div>
                </div>

                <div class="waffle-container group">
                    <button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-orange-600 transition-colors">
                        <i class="fas fa-th text-xs"></i>
                    </button>
                    <div class="absolute right-0 top-full mt-0 hidden group-hover:block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-2xl rounded-[2rem] overflow-hidden z-[60] min-w-[280px]">
                        <div class="waffle-grid">
                            <a href="landing.html" class="waffle-item text-blue-600">
                                <i class="fas fa-home"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Principal</span>
                            </a>
                            <a href="dashboard.html" class="waffle-item text-indigo-500">
                                <i class="fas fa-columns"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Flujos</span>
                            </a>
                            <a href="stats.html" class="waffle-item text-emerald-500">
                                <i class="fas fa-chart-line"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">BI Stats</span>
                            </a>
                            <a href="talleres.html" class="waffle-item text-orange-500">
                                <i class="fas fa-users-cog"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Equipo</span>
                            </a>
                            <a href="pedidos-taller.html" class="waffle-item text-purple-500">
                                <i class="fas fa-list-check"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Pedidos</span>
                            </a>
                            <a href="admin-logs.html" class="waffle-item text-slate-500">
                                <i class="fas fa-history"></i>
                                <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Logs</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="p-6 md:p-10 max-w-7xl mx-auto w-full">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <div id="db-led" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Database Linked</span>
                </div>
                <h2 class="text-4xl font-black uppercase tracking-tighter italic">Gestión de <span class="text-orange-600">Workshops</span></h2>
                <p class="text-slate-400 text-xs font-bold uppercase mt-2 tracking-widest">Control de accesos y perfiles de usuario</p>
            </div>

            <div class="flex gap-3">
                <button onclick="exportarExcel()" class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all active:scale-95">
                    <i class="fas fa-file-excel mr-2 text-emerald-500"></i> Exportar
                </button>
                <button onclick="abrirModalTaller()" class="bg-orange-600 text-white px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:opacity-90 transition-all active:scale-95 shadow-xl shadow-orange-500/20">
                    <i class="fas fa-plus mr-2"></i> Nuevo Workshop
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="busqueda" placeholder="Buscar por nombre o email..." class="w-full pl-12 pr-4 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl text-xs font-bold outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <select id="filtroProvincia" class="px-4 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl text-xs font-bold outline-none">
                <option value="">Provincia: Todas</option>
            </select>
            <select id="filtroRol" class="px-4 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl text-xs font-bold outline-none">
                <option value="">Rol: Todos</option>
                <option value="admin">Administrador</option>
                <option value="agente">Agente</option>
                <option value="taller">Workshop</option>
            </select>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-2xl overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse min-w-[1000px]">
                    <thead>
                        <tr class="bg-slate-50/50 dark:bg-slate-800/50">
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Workshop / Usuario</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Contacto</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Localización</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Rol</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaTalleres">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modalTaller" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800">
            <div class="p-10">
                <div class="flex justify-between items-center mb-8">
                    <h3 id="modal-title" class="text-2xl font-black uppercase tracking-tighter italic">Alta de <span class="text-orange-600">Workshop</span></h3>
                    <button onclick="cerrarModal()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="formTaller" class="grid grid-cols-2 gap-6">
                    <input type="hidden" id="t-id">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Nombre del Taller / Operador</label>
                        <input type="text" id="t-nombre" required class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Email de Acceso</label>
                        <input type="email" id="t-email" required class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Contraseña</label>
                        <input type="password" id="t-pass" placeholder="Dejar vacío para no cambiar" class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Rol de Sistema</label>
                        <select id="t-rol" class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="taller">Workshop (Taller)</option>
                            <option value="agente">Agente de Ventas</option>
                            <option value="admin">Administrador Root</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Provincia</label>
                        <input type="text" id="t-provincia" class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2 block">Teléfono WhatsApp</label>
                        <input type="text" id="t-whatsapp" class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-none text-xs font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    
                    <div class="col-span-2 mt-4">
                        <button type="submit" class="w-full bg-slate-900 dark:bg-orange-600 text-white py-5 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] hover:opacity-90 transition-all shadow-xl">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let talleres = [];
        let datosFiltrados = [];

        async function init() {
            checkAccess();
            await cargarTalleres();
            
            // Event Listeners para filtros
            document.getElementById('busqueda').addEventListener('input', filtrar);
            document.getElementById('filtroProvincia').addEventListener('change', filtrar);
            document.getElementById('filtroRol').addEventListener('change', filtrar);
            
            document.getElementById('formTaller').addEventListener('submit', guardarTaller);
        }

        function checkAccess() {
            const rol = localStorage.getItem('user_rol');
            const iniciales = localStorage.getItem('user_iniciales') || 'AD';
            
            if (rol !== 'admin') {
                window.location.href = 'landing.html';
                return;
            }

            const avatarDiv = document.getElementById('user-initials');
            avatarDiv.innerText = iniciales;
            // Rojo para talleres, azul para admin, verde para agente
            avatarDiv.className = `w-10 h-10 bg-slate-800 text-white rounded-full flex items-center justify-center font-black text-xs shadow-lg ring-2 ring-white dark:ring-slate-800`;
        }

        async function cargarTalleres() {
            try {
                const res = await fetch('/api/talleres');
                talleres = await res.json();
                datosFiltrados = [...talleres];
                
                renderTalleres();
                poblarProvincias();
                updateSyncStatus(true);
            } catch (err) {
                console.error("Error cargando talleres:", err);
                updateSyncStatus(false);
            }
        }

        function renderTalleres() {
            const lista = document.getElementById('listaTalleres');
            lista.innerHTML = datosFiltrados.map(t => `
                <tr class="log-row border-b border-slate-100 dark:border-slate-800 table-row-hover transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-orange-50 dark:bg-orange-900/20 text-orange-600 flex items-center justify-center font-black text-xs">
                                ${t.nombre_taller.substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-xs font-black uppercase">${t.nombre_taller}</p>
                                <p class="text-[10px] font-bold text-slate-400">${t.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6">
                        <a href="https://wa.me/${t.telefono_whatsapp}" target="_blank" class="text-[11px] font-bold text-emerald-500 hover:underline">
                            <i class="fab fa-whatsapp mr-1"></i> ${t.telefono_whatsapp || 'N/A'}
                        </a>
                    </td>
                    <td class="p-6">
                        <span class="text-[10px] font-black uppercase text-slate-500 tracking-wider">${t.provincia || '---'}</span>
                    </td>
                    <td class="p-6">
                        <span class="px-3 py-1.5 rounded-lg text-[8px] font-black uppercase ${getRolBadge(t.rol)}">
                            ${t.rol}
                        </span>
                    </td>
                    <td class="p-6 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="editarTaller(${t.id})" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-blue-500 transition-colors">
                                <i class="fas fa-edit text-[10px]"></i>
                            </button>
                            <button onclick="eliminarTaller(${t.id})" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-red-500 transition-colors">
                                <i class="fas fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getRolBadge(rol) {
            if(rol === 'admin') return 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400';
            if(rol === 'agente') return 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400';
            return 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400';
        }

        function filtrar() {
            const busq = document.getElementById('busqueda').value.toLowerCase();
            const prov = document.getElementById('filtroProvincia').value;
            const rol = document.getElementById('filtroRol').value;

            datosFiltrados = talleres.filter(t => {
                const matchBusq = t.nombre_taller.toLowerCase().includes(busq) || t.email.toLowerCase().includes(busq);
                const matchProv = prov === "" || t.provincia === prov;
                const matchRol = rol === "" || t.rol === rol;
                return matchBusq && matchProv && matchRol;
            });

            renderTalleres();
        }

        function poblarProvincias() {
            const provs = [...new Set(talleres.map(t => t.provincia).filter(p => p))];
            const select = document.getElementById('filtroProvincia');
            select.innerHTML = '<option value="">Provincia: Todas</option>' + 
                provs.sort().map(p => `<option value="${p}">${p.toUpperCase()}</option>`).join('');
        }

        function updateSyncStatus(ok) {
            document.getElementById('db-led').className = ok ? "w-2 h-2 rounded-full bg-emerald-500 animate-pulse" : "w-2 h-2 rounded-full bg-red-500";
        }

        function abrirModalTaller() {
            document.getElementById('formTaller').reset();
            document.getElementById('t-id').value = '';
            document.getElementById('modal-title').innerHTML = `Alta de <span class="text-orange-600">Workshop</span>`;
            document.getElementById('modalTaller').classList.add('modal-active');
        }

        function cerrarModal() { document.getElementById('modalTaller').classList.remove('modal-active'); }

        async function guardarTaller(e) {
            e.preventDefault();
            const id = document.getElementById('t-id').value;
            const data = {
                nombre_taller: document.getElementById('t-nombre').value,
                email: document.getElementById('t-email').value,
                password: document.getElementById('t-pass').value,
                rol: document.getElementById('t-rol').value,
                provincia: document.getElementById('t-provincia').value,
                telefono_whatsapp: document.getElementById('t-whatsapp').value
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/talleres/${id}` : '/api/talleres';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if(res.ok) {
                    cerrarModal();
                    await cargarTalleres();
                }
            } catch (err) {
                console.error("Error guardando taller:", err);
            }
        }

        function editarTaller(id) {
            const t = talleres.find(x => x.id === id);
            if(!t) return;

            document.getElementById('t-id').value = t.id;
            document.getElementById('t-nombre').value = t.nombre_taller;
            document.getElementById('t-email').value = t.email;
            document.getElementById('t-rol').value = t.rol;
            document.getElementById('t-provincia').value = t.provincia || '';
            document.getElementById('t-whatsapp').value = t.telefono_whatsapp || '';
            document.getElementById('t-pass').value = '';

            document.getElementById('modal-title').innerHTML = `Editar <span class="text-orange-600">Workshop</span>`;
            document.getElementById('modalTaller').classList.add('modal-active');
        }

        async function eliminarTaller(id) {
            if(!confirm("¿Estás seguro de eliminar este usuario?")) return;
            try {
                await fetch(`/api/talleres/${id}`, { method: 'DELETE' });
                await cargarTalleres();
            } catch (err) { console.error(err); }
        }

        function exportarExcel() {
            const data = datosFiltrados.map(u => ({
                ID: u.id, TALLER: u.nombre_taller, EMAIL: u.email, PROVINCIA: u.provincia, WHATSAPP: u.telefono_whatsapp, ROL: u.rol
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Talleres");
            XLSX.writeFile(wb, "Talleres_IA_Root.xlsx");
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
