<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipo y Talleres - Logística IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { extend: { colors: { darkBg: '#0f172a', cardDark: '#1e293b' } } }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        
        .modal-active { display: flex !important; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-container { border-radius: 2rem; overflow: hidden; }
        .row-anim { transition: all 0.2s; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .row-anim:hover { background: rgba(59, 130, 246, 0.03); transform: scale(1.002); }
        .dark .row-anim:hover { background: rgba(255,255,255,0.02); }

        .btn-action { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <nav class="sticky top-0 z-30 bg-white/80 dark:bg-darkBg/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-8 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='landing.html'" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter">Gestión <span class="text-blue-600 italic">Workshops</span></h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.3em]">Equipo y Colaboradores</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-yellow-500 transition-all">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="h-8 w-[px] bg-slate-200 dark:bg-slate-800 mx-2"></div>
                <div class="flex items-center gap-3 bg-slate-100 dark:bg-slate-800 p-1.5 pr-4 rounded-2xl">
                    <div id="user-avatar" class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-[10px]">--</div>
                    <span id="user-name" class="text-[10px] font-black uppercase tracking-tight">Cargando...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-8">
        
        <div class="flex flex-wrap items-center justify-between gap-6 mb-10">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <input type="text" id="searchInput" oninput="filtrarTalleres()" placeholder="Buscar taller, email o provincia..." class="bg-white dark:bg-cardDark border border-slate-200 dark:border-slate-800 rounded-2xl py-3.5 pl-12 pr-6 text-xs font-semibold w-80 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all shadow-sm">
                </div>
                <select id="filterRol" onchange="filtrarTalleres()" class="bg-white dark:bg-cardDark border border-slate-200 dark:border-slate-800 rounded-2xl py-3.5 px-6 text-xs font-bold outline-none focus:ring-4 focus:ring-blue-500/10 shadow-sm">
                    <option value="todos">Todos los Roles</option>
                    <option value="taller">Talleres</option>
                    <option value="agente">Agentes</option>
                    <option value="admin">Administradores</option>
                </select>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="exportarExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3.5 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Exportar
                </button>
                <button onclick="abrirModalNuevo()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3.5 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nuevo Usuario
                </button>
            </div>
        </div>

        <div class="bg-white dark:bg-cardDark table-container shadow-xl border border-slate-100 dark:border-slate-800">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 dark:bg-slate-800/50">
                        <th class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Workshop / Usuario</th>
                        <th class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Contacto</th>
                        <th class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Ubicación</th>
                        <th class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Rol</th>
                        <th class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaTalleres">
                    </tbody>
            </table>
            
            <div id="noResults" class="hidden p-20 text-center">
                <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-3xl flex items-center justify-center mx-auto mb-4 text-slate-300">
                    <i class="fas fa-users-slash text-3xl"></i>
                </div>
                <h3 class="text-sm font-black uppercase">No se encontraron resultados</h3>
                <p class="text-xs text-slate-400 mt-1">Prueba con otros términos de búsqueda.</p>
            </div>
        </div>
    </main>

    <div id="modalTaller" class="hidden fixed inset-0 z-50 items-center justify-center p-6 bg-slate-950/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-cardDark w-full max-w-xl rounded-[2.5rem] shadow-2xl border border-slate-100 dark:border-slate-800 overflow-hidden">
            <div class="p-10">
                <div class="flex justify-between items-center mb-8">
                    <h2 id="modal-title" class="text-xl font-black uppercase tracking-tight">Añadir <span class="text-blue-600">Workshop</span></h2>
                    <button onclick="cerrarModal()" class="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="tallerForm" onsubmit="guardarTaller(event)" class="space-y-6">
                    <input type="hidden" id="t-id">
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Nombre del Taller / Usuario</label>
                            <input type="text" id="t-nombre" required class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Rol en el Sistema</label>
                            <select id="t-rol" required class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-xs font-bold outline-none cursor-pointer">
                                <option value="taller">Taller (Workshop)</option>
                                <option value="agente">Agente (Gestión)</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Correo Electrónico (Acceso)</label>
                        <input type="email" id="t-email" required class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Provincia</label>
                            <input type="text" id="t-provincia" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">WhatsApp / Teléfono</label>
                            <input type="text" id="t-whatsapp" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                        </div>
                    </div>

                    <div class="p-6 bg-blue-50 dark:bg-blue-500/5 rounded-[2rem] border border-blue-100 dark:border-blue-500/10">
                        <label class="text-[9px] font-black text-blue-600 uppercase tracking-widest ml-1 block mb-2">Contraseña de acceso</label>
                        <input type="password" id="t-pass" placeholder="Dejar en blanco para no cambiar" class="w-full bg-white dark:bg-slate-900 border-none rounded-xl px-5 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                        <p class="text-[8px] text-blue-400 mt-2 font-bold uppercase tracking-tighter">* En nuevos usuarios es obligatorio.</p>
                    </div>

                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="cerrarModal()" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors">Cancelar</button>
                        <button type="submit" class="flex-1 bg-slate-900 dark:bg-blue-600 text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all shadow-xl shadow-blue-500/20">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let allTalleres = [];
        let datosFiltrados = [];

        async function init() {
            const userData = localStorage.getItem('user');
            
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = JSON.parse(userData);
                
                if (user.rol !== 'admin' && user.rol !== 'agente') {
                    alert("Acceso denegado: Se requieren permisos de gestión.");
                    window.location.href = 'landing.html';
                    return;
                }

                const userNameEl = document.getElementById('user-name');
                const userAvatarEl = document.getElementById('user-avatar');

                if (userNameEl) userNameEl.innerText = user.nombre || 'Usuario';
                if (userAvatarEl) {
                    userAvatarEl.innerText = user.iniciales || '??';
                    if (user.rol === 'admin') {
                        userAvatarEl.classList.remove('bg-blue-600');
                        userAvatarEl.classList.add('bg-red-600');
                    }
                }

            } catch (e) {
                console.error("Error en validación:", e);
                window.location.href = 'index.html';
                return;
            }

            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }

            await cargarTalleres();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
        }

        async function cargarTalleres() {
            try {
                const res = await fetch('/api/talleres');
                allTalleres = await res.json();
                filtrarTalleres();
            } catch (err) {
                console.error("Error al cargar talleres:", err);
            }
        }

        function filtrarTalleres() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const rol = document.getElementById('filterRol').value;

            datosFiltrados = allTalleres.filter(t => {
                const matchSearch = t.nombre_taller.toLowerCase().includes(search) || 
                                  t.email.toLowerCase().includes(search) ||
                                  (t.provincia && t.provincia.toLowerCase().includes(search));
                const matchRol = rol === 'todos' || t.rol === rol;
                return matchSearch && matchRol;
            });

            renderTalleres();
        }

        function renderTalleres() {
            const tbody = document.getElementById('tablaTalleres');
            const noRes = document.getElementById('noResults');
            tbody.innerHTML = '';

            if (datosFiltrados.length === 0) {
                noRes.classList.remove('hidden');
                return;
            }
            noRes.classList.add('hidden');

            datosFiltrados.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'row-anim';
                
                const rolClass = t.rol === 'admin' ? 'bg-red-100 text-red-600' : (t.rol === 'agente' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600');

                tr.innerHTML = `
                    <td class="px-8 py-5">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-black text-[10px] text-slate-400">
                                ${t.nombre_taller.substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-xs font-black uppercase tracking-tight">${t.nombre_taller}</p>
                                <p class="text-[9px] font-bold text-slate-400">ID: #${t.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5">
                        <p class="text-[11px] font-bold text-slate-600 dark:text-slate-400">${t.email}</p>
                        <p class="text-[10px] font-black text-blue-500 mt-0.5">${t.telefono_whatsapp || 'Sin Teléfono'}</p>
                    </td>
                    <td class="px-8 py-5">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">${t.provincia || 'N/A'}</span>
                    </td>
                    <td class="px-8 py-5">
                        <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${rolClass}">
                            ${t.rol}
                        </span>
                    </td>
                    <td class="px-8 py-5 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="editarTaller(${t.id})" class="btn-action bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-blue-600 hover:text-white">
                                <i class="fas fa-pen text-[10px]"></i>
                            </button>
                            <button onclick="eliminarTaller(${t.id})" class="btn-action bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-red-600 hover:text-white">
                                <i class="fas fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function abrirModalNuevo() {
            document.getElementById('t-id').value = '';
            document.getElementById('tallerForm').reset();
            document.getElementById('modal-title').innerHTML = `Añadir <span class="text-blue-600">Workshop</span>`;
            document.getElementById('modalTaller').classList.add('modal-active');
        }

        function cerrarModal() {
            document.getElementById('modalTaller').classList.remove('modal-active');
        }

        async function guardarTaller(e) {
            e.preventDefault();
            const id = document.getElementById('t-id').value;
            const data = {
                nombre_taller: document.getElementById('t-nombre').value,
                email: document.getElementById('t-email').value,
                rol: document.getElementById('t-rol').value,
                provincia: document.getElementById('t-provincia').value,
                telefono_whatsapp: document.getElementById('t-whatsapp').value,
                password: document.getElementById('t-pass').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/talleres/${id}` : '/api/talleres';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if(res.ok) {
                    cerrarModal();
                    await cargarTalleres();
                } else {
                    const err = await res.json();
                    alert("Error: " + err.error);
                }
            } catch (err) { console.error(err); }
        }

        function editarTaller(id) {
            const t = allTalleres.find(x => x.id === id);
            if(!t) return;

            document.getElementById('t-id').value = t.id;
            document.getElementById('t-nombre').value = t.nombre_taller;
            document.getElementById('t-email').value = t.email;
            document.getElementById('t-rol').value = t.rol;
            document.getElementById('t-provincia').value = t.provincia || '';
            document.getElementById('t-whatsapp').value = t.telefono_whatsapp || '';
            document.getElementById('t-pass').value = '';

            document.getElementById('modal-title').innerHTML = `Editar <span class="text-orange-600">Workshop</span>`;
            document.getElementById('modalTaller').classList.add('modal-active');
        }

        async function eliminarTaller(id) {
            if(!confirm("¿Estás seguro de eliminar este usuario?")) return;
            try {
                await fetch(`/api/talleres/${id}`, { method: 'DELETE' });
                await cargarTalleres();
            } catch (err) { console.error(err); }
        }

        function exportarExcel() {
            const data = datosFiltrados.map(u => ({
                ID: u.id, TALLER: u.nombre_taller, EMAIL: u.email, PROVINCIA: u.provincia, WHATSAPP: u.telefono_whatsapp, ROL: u.rol
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Talleres");
            XLSX.writeFile(wb, "Talleres_IA_Root.xlsx");
        }

        window.onload = init;
    </script>
</body>
</html>
