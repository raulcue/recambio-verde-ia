<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipo y Talleres - LogÃ­stica IA</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        darkBg: '#0f172a', 
                        cardDark: '#1e293b' 
                    } 
                } 
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }

        .row-anim { transition: all 0.2s; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .row-anim:hover { background: rgba(59, 130, 246, 0.03); }

        .btn-action { 
            width: 36px; 
            height: 36px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <!-- HEADER SIN CAMBIOS -->
    <!-- ... (tu header real sigue aquÃ­) -->

    <!-- âœ… CONTENEDOR REAL PARA TALLERES -->
    <main class="p-6 max-w-7xl mx-auto">

        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow overflow-hidden">

            <!-- FILTROS -->
            <div class="p-4 border-b flex flex-col sm:flex-row gap-3">
                <input 
                    id="searchInput"
                    oninput="filtrarTalleres()"
                    placeholder="Buscar taller..."
                    class="flex-1 bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-lg text-sm outline-none"
                />

                <select 
                    id="filterRol"
                    onchange="filtrarTalleres()"
                    class="bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-lg text-sm outline-none"
                >
                    <option value="todos">Todos</option>
                    <option value="taller">Solo Taller</option>
                </select>
            </div>

            <!-- TABLA -->
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-xs uppercase">
                        <tr>
                            <th class="px-6 py-3">Taller</th>
                            <th class="px-6 py-3">Email</th>
                            <th class="px-6 py-3">Provincia</th>
                            <th class="px-6 py-3">Rol</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>

                    <!-- ðŸ”´ ESTE TBODY ES EL QUE USA EL JS -->
                    <tbody id="tablaTalleres"></tbody>
                </table>

                <div id="noResults" class="hidden text-center text-slate-400 p-6">
                    No hay resultados
                </div>
            </div>

        </div>
    </main>

    <script>
        let allTalleres = [];
        let datosFiltrados = [];

        async function init() {
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = JSON.parse(userData);
                if (user.rol !== 'admin' && user.rol !== 'agente') {
                    alert("Acceso denegado");
                    window.location.href = 'landing.html';
                    return;
                }
            } catch (e) {
                console.error("Error en validaciÃ³n:", e);
                window.location.href = 'index.html';
                return;
            }

            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }

            await cargarTalleres();
        }

        // =============================
        // CARGA DE TALLERES
        // =============================
        async function cargarTalleres() {
            try {
                const res = await fetch('/api/usuarios?rol=taller', { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                allTalleres = await res.json();
                console.log('Talleres cargados:', allTalleres.length);

                filtrarTalleres();
            } catch (err) {
                console.error("Error al cargar talleres:", err);
                alert("Error conectando con la base de datos");
            }
        }

        // =============================
        // FILTRO
        // =============================
        function filtrarTalleres() {
            const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const rol = document.getElementById('filterRol')?.value || 'todos';

            datosFiltrados = allTalleres.filter(t => {
                const matchSearch =
                    (t.nombre_taller || '').toLowerCase().includes(search) ||
                    (t.email || '').toLowerCase().includes(search) ||
                    (t.provincia || '').toLowerCase().includes(search);

                const matchRol = rol === 'todos' || t.rol === rol;
                return matchSearch && matchRol;
            });

            renderTalleres();
        }

        // =============================
        // RENDER
        // =============================
        function renderTalleres() {
            const tbody = document.getElementById('tablaTalleres');
            const noRes = document.getElementById('noResults');

            if (!tbody) {
                console.error('âŒ No existe #tablaTalleres en el DOM');
                return;
            }

            tbody.innerHTML = '';

            if (datosFiltrados.length === 0) {
                noRes.classList.remove('hidden');
                return;
            } else {
                noRes.classList.add('hidden');
            }

            datosFiltrados.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'row-anim';

                const rolClass =
                    t.rol === 'admin' ? 'bg-red-100 text-red-600' :
                    (t.rol === 'agente' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600');

                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold">${t.nombre_taller || 'Sin nombre'}</td>
                    <td class="px-6 py-4">${t.email || ''}</td>
                    <td class="px-6 py-4">${t.provincia || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black ${rolClass}">
                            ${t.rol}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editarTaller(${t.id})" class="btn-action bg-slate-100 hover:bg-blue-600 hover:text-white">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button onclick="eliminarTaller(${t.id})" class="btn-action bg-slate-100 hover:bg-red-600 hover:text-white ml-2">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // =============================
        // ACCIONES
        // =============================
        function editarTaller(id) {
            alert("Editar taller ID: " + id);
        }

        async function eliminarTaller(id) {
            if (!confirm("Â¿Eliminar este taller?")) return;

            try {
                await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
                await cargarTalleres();
            } catch (err) {
                console.error(err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
