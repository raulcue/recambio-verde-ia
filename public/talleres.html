<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipo y Talleres - Log√≠stica IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { extend: { colors: { darkBg: '#0f172a', cardDark: '#1e293b' } } }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        
        .modal-active { display: flex !important; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-container { border-radius: 2rem; overflow: hidden; }
        .row-anim { transition: all 0.2s; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .row-anim:hover { background: rgba(59, 130, 246, 0.03); transform: scale(1.002); }
        .dark .row-anim:hover { background: rgba(255,255,255,0.02); }

        .btn-action { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <!-- HEADER SIN CAMBIOS -->
    <!-- ... (todo el HTML visual permanece exactamente igual) -->

    <script>
        let allTalleres = [];
        let datosFiltrados = [];

        async function init() {
            const userData = localStorage.getItem('user');
            
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = JSON.parse(userData);
                
                if (user.rol !== 'admin' && user.rol !== 'agente') {
                    alert("Acceso denegado: Se requieren permisos de gesti√≥n.");
                    window.location.href = 'landing.html';
                    return;
                }

                const userNameEl = document.getElementById('user-name');
                const userAvatarEl = document.getElementById('user-avatar');

                if (userNameEl) userNameEl.innerText = user.nombre || 'Usuario';
                if (userAvatarEl) {
                    userAvatarEl.innerText = user.iniciales || '??';
                    if (user.rol === 'admin') {
                        userAvatarEl.classList.remove('bg-blue-600');
                        userAvatarEl.classList.add('bg-red-600');
                    }
                }

            } catch (e) {
                console.error("Error en validaci√≥n:", e);
                window.location.href = 'index.html';
                return;
            }

            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }

            await cargarTalleres();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
        }

        // ‚úÖ CAMBIO PRINCIPAL AQU√ç
        async function cargarTalleres() {
            try {
                const res = await fetch('/api/usuarios?rol=taller', {
                    cache: 'no-store'
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                allTalleres = await res.json();
                filtrarTalleres();

            } catch (err) {
                console.error("Error al cargar talleres:", err);
                alert("Error conectando con la base de datos");
            }
        }

        function filtrarTalleres() {
    const searchEl = document.getElementById('searchInput');
    const rolEl = document.getElementById('filterRol');

    // üõ°Ô∏è Protecci√≥n contra null (evita el crash actual)
    const search = searchEl ? searchEl.value.toLowerCase() : '';
    const rol = rolEl ? rolEl.value : 'todos';

    datosFiltrados = allTalleres.filter(t => {
        const matchSearch = 
            (t.nombre_taller || '').toLowerCase().includes(search) || 
            (t.email || '').toLowerCase().includes(search) ||
            (t.provincia || '').toLowerCase().includes(search);

        const matchRol = rol === 'todos' || t.rol === rol;
        return matchSearch && matchRol;
    });

    renderTalleres();
}

        function renderTalleres() {
            const tbody = document.getElementById('tablaTalleres');
            const noRes = document.getElementById('noResults');
            tbody.innerHTML = '';

            if (datosFiltrados.length === 0) {
                noRes.classList.remove('hidden');
                return;
            }
            noRes.classList.add('hidden');

            datosFiltrados.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'row-anim';
                
                const rolClass = 
                    t.rol === 'admin' ? 'bg-red-100 text-red-600' : 
                    (t.rol === 'agente' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600');

                tr.innerHTML = `
                    <td class="px-8 py-5">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-black text-[10px] text-slate-400">
                                ${(t.nombre_taller || '??').substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-xs font-black uppercase tracking-tight">${t.nombre_taller || 'Sin nombre'}</p>
                                <p class="text-[9px] font-bold text-slate-400">ID: #${t.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5">
                        <p class="text-[11px] font-bold text-slate-600 dark:text-slate-400">${t.email || ''}</p>
                        <p class="text-[10px] font-black text-blue-500 mt-0.5">${t.telefono_whatsapp || 'Sin Tel√©fono'}</p>
                    </td>
                    <td class="px-8 py-5">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">${t.provincia || 'N/A'}</span>
                    </td>
                    <td class="px-8 py-5">
                        <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${rolClass}">
                            ${t.rol}
                        </span>
                    </td>
                    <td class="px-8 py-5 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="editarTaller(${t.id})" class="btn-action bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-blue-600 hover:text-white">
                                <i class="fas fa-pen text-[10px]"></i>
                            </button>
                            <button onclick="eliminarTaller(${t.id})" class="btn-action bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-red-600 hover:text-white">
                                <i class="fas fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ‚úÖ CAMBIO URL AQU√ç
        async function guardarTaller(e) {
            e.preventDefault();
            const id = document.getElementById('t-id').value;

            const data = {
                nombre_taller: document.getElementById('t-nombre').value,
                email: document.getElementById('t-email').value,
                rol: document.getElementById('t-rol').value,
                provincia: document.getElementById('t-provincia').value,
                telefono_whatsapp: document.getElementById('t-whatsapp').value,
                password: document.getElementById('t-pass').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/usuarios/${id}` : '/api/usuarios';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if(res.ok) {
                    cerrarModal();
                    await cargarTalleres();
                } else {
                    const err = await res.json();
                    alert("Error: " + err.error);
                }

            } catch (err) { 
                console.error(err); 
            }
        }

        function editarTaller(id) {
            const t = allTalleres.find(x => x.id === id);
            if(!t) return;

            document.getElementById('t-id').value = t.id;
            document.getElementById('t-nombre').value = t.nombre_taller;
            document.getElementById('t-email').value = t.email;
            document.getElementById('t-rol').value = t.rol;
            document.getElementById('t-provincia').value = t.provincia || '';
            document.getElementById('t-whatsapp').value = t.telefono_whatsapp || '';
            document.getElementById('t-pass').value = '';

            document.getElementById('modal-title').innerHTML = `Editar <span class="text-orange-600">Workshop</span>`;
            document.getElementById('modalTaller').classList.add('modal-active');
        }

        // ‚úÖ CAMBIO URL AQU√ç
        async function eliminarTaller(id) {
            if(!confirm("¬øEst√°s seguro de eliminar este usuario?")) return;

            try {
                await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
                await cargarTalleres();
            } catch (err) { 
                console.error(err); 
            }
        }

        window.onload = init;
    </script>
</body>
</html>
