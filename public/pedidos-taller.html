<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taller - Recambio Reciclado IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="/js/global.js"></script>
    <style>
        .details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .expanded .details { max-height: 200px; border-top: 1px solid #f1f5f9; margin-top: 12px; padding-top: 12px; }
        .expanded .chevron { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24">

    <main class="p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-8 mt-4">
            <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter border-l-4 border-green-500 pl-3">Mis Recambios</h2>
            <button onclick="document.getElementById('modal').style.display='flex'" class="bg-green-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="lista" class="space-y-3">
            </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[100]">
        <form id="formPedido" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl space-y-4">
            <h3 class="font-black text-slate-800 uppercase text-lg mb-6 tracking-tighter">Nueva Solicitud</h3>
            <input type="text" id="pieza" placeholder="Nombre de la Pieza" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="marca" placeholder="Marca" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500">
                <input type="text" id="modelo" placeholder="Modelo" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <input type="text" id="matricula" placeholder="Matrícula" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500 uppercase">
            <div class="flex gap-4 pt-4">
                <button type="button" onclick="document.getElementById('modal').style.display='none'" class="flex-1 text-[10px] font-black uppercase text-slate-400">Cancelar</button>
                <button type="submit" class="flex-[2] bg-slate-800 text-white p-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">Enviar Pedido</button>
            </div>
        </form>
    </div>

    <script>
        // Función para alternar la vista expandida
        function toggleCard(el) {
            el.classList.toggle('expanded');
        }

        async function load() {
            const res = await fetch('/api/pedidos');
            const data = await res.json();
            const estados = ["", "Pedido", "En Desguace", "Listo Envío", "En Tránsito", "Entregado", "Incidencia"];
            
            document.getElementById('lista').innerHTML = data.map(p => {
                const badgeColor = p.estado === 1 ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-500';
                
                return `
                <div class="bg-white p-5 rounded-[1.5rem] border border-slate-200 shadow-sm transition-all" onclick="toggleCard(this)">
                    <div class="flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="text-[8px] font-black text-slate-300 uppercase tracking-widest">${p.numero_pedido}</span>
                            <h4 class="font-black text-slate-800 uppercase text-sm leading-tight">${p.pieza}</h4>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${badgeColor}">${estados[p.estado]}</span>
                            <i class="fas fa-chevron-down text-slate-300 text-xs chevron transition-transform"></i>
                        </div>
                    </div>

                    <div class="details">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Vehículo</p>
                                <p class="text-[11px] font-bold text-slate-700 uppercase">${p.marca_coche} ${p.modelo_coche}</p>
                            </div>
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Matrícula</p>
                                <p class="text-[11px] font-bold text-slate-700 uppercase">${p.matricula}</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('formPedido').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                numero_pedido: 'RV-' + Math.floor(Math.random()*9000+1000),
                pieza: document.getElementById('pieza').value,
                marca_coche: document.getElementById('marca').value,
                modelo_coche: document.getElementById('modelo').value,
                matricula: document.getElementById('matricula').value,
                estado: 1
            };

            await fetch('/api/pedidos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            document.getElementById('modal').style.display='none';
            load();
            e.target.reset();
        };

        load();
    </script>
</body>
</html>
